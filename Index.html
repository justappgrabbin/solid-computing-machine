<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Causal Code Studio ‚Äî HD Neural Graph</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<style>
  :root {
    --bg: #0d0814;
    --surface: #12091c;
    --surface2: #1a0f28;
    --border: #2a1a42;
    --primary: #c084fc;
    --primary-dim: #7c3aed;
    --accent: #f0abfc;
    --gold: #fbbf24;
    --red: #f87171;
    --green: #4ade80;
    --blue: #60a5fa;
    --text: #e2d9f3;
    --muted: #8b7aa8;
    --head-c: #a78bfa;
    --ajna-c: #818cf8;
    --throat-c: #c084fc;
    --g-c: #fbbf24;
    --heart-c: #f87171;
    --spleen-c: #4ade80;
    --solar-c: #fb923c;
    --sacral-c: #f87171;
    --root-c: #d946ef;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; overflow-x: hidden; }

  /* LOADER */
  #loader {
    position: fixed; inset: 0; background: var(--bg); z-index: 1000;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  .loader-ring {
    width: 80px; height: 80px; border-radius: 50%;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { color: var(--muted); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; }
  #loader-status { color: var(--accent); font-size: 12px; }

  /* HEADER */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-brand { display: flex; align-items: center; gap: 12px; }
  .brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary-dim), var(--primary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .brand-title { font-size: 16px; font-weight: 600; color: var(--text); }
  .brand-sub { font-size: 11px; color: var(--muted); }
  .header-actions { display: flex; gap: 8px; }
  .btn { padding: 7px 14px; border-radius: 7px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); cursor: pointer; font-size: 12px; transition: all 0.2s; }
  .btn:hover { border-color: var(--primary); color: var(--primary); }
  .btn-primary { background: var(--primary-dim); border-color: var(--primary-dim); color: white; }
  .btn-primary:hover { background: var(--primary); border-color: var(--primary); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* LAYOUT */
  .main { max-width: 1400px; margin: 0 auto; padding: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: 1fr; } }

  /* CARDS */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .card-header { padding: 14px 18px 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .card-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .card-body { padding: 16px 18px; }

  /* FORM */
  .placements-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
  .placement-row { display: grid; grid-template-columns: 1fr 80px 60px 50px 24px; gap: 6px; align-items: center; background: var(--surface2); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); }
  select, input[type=number] {
    background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 5px 8px;
    border-radius: 6px; font-size: 12px; width: 100%;
  }
  select:focus, input:focus { outline: none; border-color: var(--primary); }
  .remove-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; padding: 2px 4px; }
  .remove-btn:hover { color: var(--red); }
  label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 3px; }
  .field-group { }
  .transit-row { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--surface2); border-radius: 8px; border: 1px solid var(--border); margin-top: 8px; }
  .transit-row label { margin: 0; white-space: nowrap; }

  /* GRAPH */
  #graph-svg { width: 100%; background: var(--surface2); border-radius: 8px; cursor: grab; user-select: none; }
  #graph-svg:active { cursor: grabbing; }
  .graph-controls { display: flex; gap: 6px; }

  /* CODON GRID */
  .codon-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
  .codon-cell {
    aspect-ratio: 1; border-radius: 6px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; font-size: 10px; cursor: pointer;
    border: 1px solid transparent; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .codon-cell.activated { border-color: var(--primary-dim); }
  .codon-cell:hover { transform: scale(1.05); z-index: 2; }
  .codon-num { font-weight: 700; font-size: 11px; }
  .codon-score { font-size: 9px; opacity: 0.7; }

  /* AWARENESS */
  .awareness-card { background: var(--surface2); border-radius: 10px; padding: 14px; border: 1px solid var(--border); }
  .awareness-label { font-size: 12px; font-weight: 600; margin-bottom: 8px; }
  .bar-wrap { background: var(--bg); border-radius: 4px; height: 8px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
  .awareness-score { font-size: 20px; font-weight: 700; margin: 6px 0 4px; }
  .gates-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
  .gate-pill { background: var(--bg); border-radius: 4px; padding: 2px 6px; font-size: 10px; border: 1px solid var(--border); }
  .gate-pill.active { border-color: var(--primary); color: var(--primary); }

  /* MODULATORS */
  .film-params { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
  .film-param { background: var(--bg); border-radius: 7px; padding: 8px 10px; border: 1px solid var(--border); }
  .param-name { font-size: 10px; color: var(--muted); }
  .param-val { font-size: 16px; font-weight: 700; color: var(--accent); font-family: monospace; }

  /* ALCHEMY */
  .tria-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .tria-card { text-align: center; background: var(--bg); border-radius: 8px; padding: 12px; border: 1px solid var(--border); }
  .tria-symbol { font-size: 28px; line-height: 1; margin-bottom: 4px; }
  .tria-name { font-size: 11px; color: var(--muted); }
  .tria-score { font-size: 18px; font-weight: 700; margin: 4px 0; }
  .phase-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; background: var(--surface2); border: 1px solid var(--border); }
  .interaction-row { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
  .coupling-val { font-size: 11px; color: var(--muted); }
  .coupling-val span { color: var(--text); font-weight: 600; }

  /* SENTENCES */
  .sentence-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
  .sentence-item { background: var(--surface2); border-radius: 8px; padding: 10px 12px; border-left: 3px solid var(--primary-dim); }
  .sentence-text { font-size: 12px; font-style: italic; color: var(--accent); margin-bottom: 4px; }
  .sentence-meta { font-size: 10px; color: var(--muted); }

  /* TOOLTIP */
  #tooltip { position: fixed; pointer-events: none; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 12px; max-width: 220px; z-index: 999; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
  #tooltip strong { color: var(--primary); }
  #tooltip .tt-sub { color: var(--muted); font-size: 11px; }

  /* STATUS */
  .status-bar { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--surface2); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 16px; font-size: 12px; color: var(--muted); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-yellow { background: var(--gold); box-shadow: 0 0 6px var(--gold); }
  .dot-red { background: var(--red); }

  /* SECTION HEADER */
  .section-title { font-size: 16px; font-weight: 600; margin: 24px 0 12px; color: var(--text); }
  .divider { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

  /* BADGE */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .badge-primary { background: rgba(192,132,252,0.15); color: var(--primary); border: 1px solid var(--primary-dim); }
  .badge-secondary { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* TOGGLE */
  .toggle-wrap { display: flex; align-items: center; gap: 8px; }
  .toggle { appearance: none; width: 36px; height: 20px; background: var(--border); border-radius: 10px; cursor: pointer; position: relative; transition: background 0.2s; }
  .toggle:checked { background: var(--primary-dim); }
  .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 14px; height: 14px; background: white; border-radius: 50%; transition: left 0.2s; }
  .toggle:checked::after { left: 19px; }

  .hidden { display: none !important; }

  /* Narrative */
  .narrative { background: var(--surface2); border-radius: 8px; padding: 14px; border: 1px solid var(--border); font-size: 13px; line-height: 1.7; color: var(--text); font-style: italic; }

  /* Channel defined badge */
  .defined-badge { background: rgba(192,132,252,0.1); border: 1px solid var(--primary-dim); border-radius: 6px; padding: 2px 6px; font-size: 10px; color: var(--primary); }
</style>
</head>
<body>

<div id="loader">
  <div class="loader-ring"></div>
  <div class="loader-text">Causal Code Studio</div>
  <div id="loader-status">Initializing Pyodide‚Ä¶</div>
</div>

<div id="app" class="hidden">
  <header>
    <div class="header-brand">
      <div class="brand-icon">‚¨°</div>
      <div>
        <div class="brand-title">Causal Code Studio</div>
        <div class="brand-sub">HD Neural Graph ¬∑ Consciousness Analysis</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn" id="btn-new" onclick="resetChart()" style="display:none">‚Ü∫ New Chart</button>
      <button class="btn" id="btn-export" onclick="exportJSON()" style="display:none">‚¨á Export JSON</button>
    </div>
  </header>

  <div class="main">
    <div id="status-bar" class="status-bar">
      <div class="status-dot dot-green"></div>
      <span>Pyodide ready ¬∑ Python causal graph engine running in-browser</span>
    </div>

    <!-- INPUT SECTION -->
    <div id="input-section" class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚ú¶ Chart Placements</div>
          <div>
            <button class="btn" onclick="addPlacement()">+ Add</button>
          </div>
        </div>
        <div class="card-body">
          <div style="display:grid; grid-template-columns:1fr 80px 60px 50px 24px; gap:6px; padding:0 10px 6px; margin-bottom:2px;">
            <span style="font-size:10px;color:var(--muted)">Planet</span>
            <span style="font-size:10px;color:var(--muted)">Stream</span>
            <span style="font-size:10px;color:var(--muted)">Gate</span>
            <span style="font-size:10px;color:var(--muted)">Line</span>
            <span></span>
          </div>
          <div class="placements-list" id="placements-list"></div>
          <div class="transit-row" style="margin-top:12px;">
            <div class="toggle-wrap">
              <input type="checkbox" class="toggle" id="use-transit" onchange="toggleTransit()">
              <label for="use-transit" style="margin:0;font-size:12px;color:var(--text)">Transit Sun override</label>
            </div>
            <div id="transit-inputs" style="display:none;gap:8px;display:none;align-items:center">
              <div>
                <label>Gate</label>
                <input type="number" id="transit-gate" value="1" min="1" max="64" style="width:60px">
              </div>
              <div>
                <label>Line</label>
                <input type="number" id="transit-line" value="1" min="1" max="6" style="width:50px">
              </div>
            </div>
          </div>
          <button class="btn btn-primary" id="btn-analyze" onclick="analyzeChart()" style="width:100%;margin-top:14px;padding:10px;font-size:14px;">
            ‚ú¶ Analyze Chart
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">‚¨° Channel Graph Preview</div>
          <div class="graph-controls">
            <button class="btn" onclick="zoomGraph(-0.2)">‚àí</button>
            <button class="btn" onclick="zoomGraph(0.2)">+</button>
            <button class="btn" onclick="resetZoom()">‚åÄ</button>
          </div>
        </div>
        <div class="card-body" style="padding:8px">
          <svg id="graph-svg" viewBox="0 0 440 560" height="520"></svg>
        </div>
      </div>
    </div>

    <!-- RESULTS SECTION (hidden until analyzed) -->
    <div id="results-section" class="hidden">
      <div style="display:flex;align-items:center;gap:12px;margin:24px 0 16px">
        <h2 style="font-size:20px;font-weight:600">Chart Analysis</h2>
        <span class="badge badge-primary" id="badge-gates">‚Äî gates</span>
        <span class="badge badge-secondary" id="badge-channels">‚Äî channels</span>
        <span style="font-size:12px;color:var(--muted)" id="body-sun-label"></span>
      </div>

      <div class="grid-2" style="margin-bottom:20px">
        <!-- Graph (results view) -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">‚¨° Causal Channel Graph</div>
            <div class="graph-controls">
              <button class="btn" onclick="zoomGraph(-0.2)">‚àí</button>
              <button class="btn" onclick="zoomGraph(0.2)">+</button>
              <button class="btn" onclick="resetZoom()">‚åÄ</button>
            </div>
          </div>
          <div class="card-body" style="padding:8px">
            <svg id="graph-svg-results" viewBox="0 0 440 560" height="520"></svg>
          </div>
        </div>

        <!-- Codon Grid -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">‚óà 64-Gate Codon Grid</div>
          </div>
          <div class="card-body">
            <div class="codon-grid" id="codon-grid"></div>
          </div>
        </div>
      </div>

      <hr class="divider">
      <div class="section-title">Awareness Metrics</div>
      <div class="grid-3" id="awareness-grid"></div>

      <hr class="divider">
      <div class="grid-2" style="margin-bottom:20px">
        <!-- Modulators -->
        <div class="card">
          <div class="card-header"><div class="card-title">‚öô FiLM Modulators</div></div>
          <div class="card-body" id="modulators-body"></div>
        </div>
        <!-- Alchemy -->
        <div class="card">
          <div class="card-header"><div class="card-title">üúç Tria Prima Alchemy</div></div>
          <div class="card-body" id="alchemy-body"></div>
        </div>
      </div>

      <!-- Sentences -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-header"><div class="card-title">‚àø Resonance Sentences</div></div>
        <div class="card-body">
          <div class="sentence-list" id="sentence-list"></div>
        </div>
      </div>

      <!-- Narrative -->
      <div class="card">
        <div class="card-header"><div class="card-title">‚óâ Consciousness Narrative</div></div>
        <div class="card-body">
          <div class="narrative" id="narrative-panel"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="tooltip"></div>

<script>
// ============================================================
// DATA CONSTANTS (from schema.ts)
// ============================================================
const PLANETS = ["Sun","Earth","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","North Node","South Node"];
const STREAMS = ["body","design"];

const GATE_DATA = [
  {id:1,name:"The Creative",center:"G",circuitGroup:"Individual",channels:[8]},
  {id:2,name:"The Receptive",center:"G",circuitGroup:"Individual",channels:[14]},
  {id:3,name:"Difficulty at the Beginning",center:"Sacral",circuitGroup:"Individual",channels:[60]},
  {id:4,name:"Youthful Folly",center:"Ajna",circuitGroup:"Collective",channels:[63]},
  {id:5,name:"Waiting",center:"Sacral",circuitGroup:"Collective",channels:[15]},
  {id:6,name:"Conflict",center:"Solar Plexus",circuitGroup:"Tribal",channels:[59]},
  {id:7,name:"The Army",center:"G",circuitGroup:"Collective",channels:[31]},
  {id:8,name:"Holding Together",center:"Throat",circuitGroup:"Individual",channels:[1]},
  {id:9,name:"The Taming Power of the Small",center:"Sacral",circuitGroup:"Collective",channels:[52]},
  {id:10,name:"Treading",center:"G",circuitGroup:"Individual",channels:[20,34,57]},
  {id:11,name:"Peace",center:"Ajna",circuitGroup:"Collective",channels:[56]},
  {id:12,name:"Standstill",center:"Throat",circuitGroup:"Individual",channels:[22]},
  {id:13,name:"Fellowship of Man",center:"G",circuitGroup:"Collective",channels:[33]},
  {id:14,name:"Possession in Great Measure",center:"Sacral",circuitGroup:"Individual",channels:[2]},
  {id:15,name:"Modesty",center:"G",circuitGroup:"Collective",channels:[5]},
  {id:16,name:"Enthusiasm",center:"Throat",circuitGroup:"Collective",channels:[48]},
  {id:17,name:"Following",center:"Ajna",circuitGroup:"Collective",channels:[62]},
  {id:18,name:"Work on What Has Been Spoilt",center:"Spleen",circuitGroup:"Collective",channels:[58]},
  {id:19,name:"Approach",center:"Root",circuitGroup:"Tribal",channels:[49]},
  {id:20,name:"Contemplation",center:"Throat",circuitGroup:"Individual",channels:[10,34,57]},
  {id:21,name:"Biting Through",center:"Heart",circuitGroup:"Tribal",channels:[45]},
  {id:22,name:"Grace",center:"Solar Plexus",circuitGroup:"Individual",channels:[12]},
  {id:23,name:"Splitting Apart",center:"Throat",circuitGroup:"Individual",channels:[43]},
  {id:24,name:"Returning",center:"Ajna",circuitGroup:"Individual",channels:[61]},
  {id:25,name:"Innocence",center:"G",circuitGroup:"Individual",channels:[51]},
  {id:26,name:"Taming Power of the Great",center:"Heart",circuitGroup:"Tribal",channels:[44]},
  {id:27,name:"Nourishment",center:"Sacral",circuitGroup:"Tribal",channels:[50]},
  {id:28,name:"Preponderance of the Great",center:"Spleen",circuitGroup:"Individual",channels:[38]},
  {id:29,name:"The Abysmal",center:"Sacral",circuitGroup:"Collective",channels:[46]},
  {id:30,name:"The Clinging Fire",center:"Solar Plexus",circuitGroup:"Collective",channels:[41]},
  {id:31,name:"Influence",center:"Throat",circuitGroup:"Collective",channels:[7]},
  {id:32,name:"Duration",center:"Spleen",circuitGroup:"Tribal",channels:[54]},
  {id:33,name:"Retreat",center:"Throat",circuitGroup:"Collective",channels:[13]},
  {id:34,name:"Power of the Great",center:"Sacral",circuitGroup:"Individual",channels:[10,20,57]},
  {id:35,name:"Progress",center:"Throat",circuitGroup:"Collective",channels:[36]},
  {id:36,name:"Darkening of the Light",center:"Solar Plexus",circuitGroup:"Collective",channels:[35]},
  {id:37,name:"The Family",center:"Solar Plexus",circuitGroup:"Tribal",channels:[40]},
  {id:38,name:"Opposition",center:"Root",circuitGroup:"Individual",channels:[28]},
  {id:39,name:"Obstruction",center:"Root",circuitGroup:"Individual",channels:[55]},
  {id:40,name:"Deliverance",center:"Heart",circuitGroup:"Tribal",channels:[37]},
  {id:41,name:"Decrease",center:"Root",circuitGroup:"Collective",channels:[30]},
  {id:42,name:"Increase",center:"Sacral",circuitGroup:"Collective",channels:[53]},
  {id:43,name:"Breakthrough",center:"Ajna",circuitGroup:"Individual",channels:[23]},
  {id:44,name:"Coming to Meet",center:"Spleen",circuitGroup:"Tribal",channels:[26]},
  {id:45,name:"Gathering Together",center:"Throat",circuitGroup:"Tribal",channels:[21]},
  {id:46,name:"Pushing Upward",center:"G",circuitGroup:"Collective",channels:[29]},
  {id:47,name:"Oppression",center:"Ajna",circuitGroup:"Collective",channels:[64]},
  {id:48,name:"The Well",center:"Spleen",circuitGroup:"Collective",channels:[16]},
  {id:49,name:"Revolution",center:"Solar Plexus",circuitGroup:"Tribal",channels:[19]},
  {id:50,name:"The Cauldron",center:"Spleen",circuitGroup:"Tribal",channels:[27]},
  {id:51,name:"The Arousing",center:"Heart",circuitGroup:"Individual",channels:[25]},
  {id:52,name:"Keeping Still",center:"Root",circuitGroup:"Collective",channels:[9]},
  {id:53,name:"Development",center:"Root",circuitGroup:"Collective",channels:[42]},
  {id:54,name:"The Marrying Maiden",center:"Root",circuitGroup:"Tribal",channels:[32]},
  {id:55,name:"Abundance",center:"Solar Plexus",circuitGroup:"Individual",channels:[39]},
  {id:56,name:"The Wanderer",center:"Throat",circuitGroup:"Collective",channels:[11]},
  {id:57,name:"The Gentle",center:"Spleen",circuitGroup:"Integration",channels:[10,20,34]},
  {id:58,name:"The Joyous",center:"Root",circuitGroup:"Collective",channels:[18]},
  {id:59,name:"Dispersion",center:"Sacral",circuitGroup:"Tribal",channels:[6]},
  {id:60,name:"Limitation",center:"Root",circuitGroup:"Individual",channels:[3]},
  {id:61,name:"Inner Truth",center:"Head",circuitGroup:"Individual",channels:[24]},
  {id:62,name:"Preponderance of the Small",center:"Throat",circuitGroup:"Collective",channels:[17]},
  {id:63,name:"After Completion",center:"Head",circuitGroup:"Collective",channels:[4]},
  {id:64,name:"Before Completion",center:"Head",circuitGroup:"Collective",channels:[47]},
];

const CHANNEL_EDGES = [
  [1,8],[2,14],[3,60],[4,63],[5,15],[6,59],[7,31],
  [9,52],[10,20],[10,34],[10,57],[11,56],[12,22],[13,33],
  [16,48],[17,62],[18,58],[19,49],[20,34],[20,57],[21,45],
  [23,43],[24,61],[25,51],[26,44],[27,50],[28,38],[29,46],
  [30,41],[32,54],[34,57],[35,36],[37,40],[39,55],[42,53],
  [47,64]
];

const CENTER_COLORS = {
  "Head":"#a78bfa","Ajna":"#818cf8","Throat":"#c084fc","G":"#fbbf24",
  "Heart":"#f87171","Spleen":"#4ade80","Solar Plexus":"#fb923c",
  "Sacral":"#f87171","Root":"#d946ef"
};

const CENTER_POSITIONS = {
  "Head":{x:220,y:35},"Ajna":{x:220,y:100},"Throat":{x:220,y:185},
  "G":{x:220,y:285},"Heart":{x:310,y:245},"Spleen":{x:115,y:355},
  "Solar Plexus":{x:325,y:355},"Sacral":{x:220,y:415},"Root":{x:220,y:500}
};

// ============================================================
// PLACEMENT STATE
// ============================================================
let placements = [
  {planet:"Sun", stream:"body", gate:46, line:3},
  {planet:"Earth", stream:"body", gate:25, line:3},
  {planet:"Moon", stream:"body", gate:30, line:2},
  {planet:"Sun", stream:"design", gate:4, line:5},
  {planet:"Earth", stream:"design", gate:49, line:5},
  {planet:"Mercury", stream:"body", gate:59, line:1},
  {planet:"Mars", stream:"design", gate:6, line:1},
];

let chartData = null;
let graphZoom = 1;
let pyodide = null;

// ============================================================
// PYODIDE PYTHON ENGINE
// ============================================================
const PYTHON_ENGINE = `
import math
import json
from typing import List, Dict, Optional, Tuple

CHANNEL_EDGES = [
  (1,8),(2,14),(3,60),(4,63),(5,15),(6,59),(7,31),
  (9,52),(10,20),(10,34),(10,57),(11,56),(12,22),(13,33),
  (16,48),(17,62),(18,58),(19,49),(20,34),(20,57),(21,45),
  (23,43),(24,61),(25,51),(26,44),(27,50),(28,38),(29,46),
  (30,41),(32,54),(34,57),(35,36),(37,40),(39,55),(42,53),
  (47,64)
]

AWARENESS_SETS = {
  "spleen": {57,44,50,32,28,18},
  "ajna": {47,24,4,17,11,43},
  "solar_plexus": {55,49,37,22,30,36,6},
}

HEART_GATES = {21,51,26,40}
MIND_GATES  = {47,24,4,17,11,43}

PLANETS = ["Sun","Earth","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","North Node","South Node"]

GATE_TO_CENTER = {
  1:"G",2:"G",3:"Sacral",4:"Ajna",5:"Sacral",6:"Solar Plexus",7:"G",8:"Throat",
  9:"Sacral",10:"G",11:"Ajna",12:"Throat",13:"G",14:"Sacral",15:"G",16:"Throat",
  17:"Ajna",18:"Spleen",19:"Root",20:"Throat",21:"Heart",22:"Solar Plexus",
  23:"Throat",24:"Ajna",25:"G",26:"Heart",27:"Sacral",28:"Spleen",29:"Sacral",
  30:"Solar Plexus",31:"Throat",32:"Spleen",33:"Throat",34:"Sacral",35:"Throat",
  36:"Solar Plexus",37:"Solar Plexus",38:"Root",39:"Root",40:"Heart",41:"Root",
  42:"Sacral",43:"Ajna",44:"Spleen",45:"Throat",46:"G",47:"Ajna",48:"Spleen",
  49:"Solar Plexus",50:"Spleen",51:"Heart",52:"Root",53:"Root",54:"Root",
  55:"Solar Plexus",56:"Throat",57:"Spleen",58:"Root",59:"Sacral",60:"Root",
  61:"Head",62:"Throat",63:"Head",64:"Head"
}

GATE_CIRCUIT = {
  1:"Individual",2:"Individual",3:"Individual",4:"Collective",5:"Collective",6:"Tribal",7:"Collective",8:"Individual",
  9:"Collective",10:"Individual",11:"Collective",12:"Individual",13:"Collective",14:"Individual",15:"Collective",16:"Collective",
  17:"Collective",18:"Collective",19:"Tribal",20:"Individual",21:"Tribal",22:"Individual",23:"Individual",24:"Individual",
  25:"Individual",26:"Tribal",27:"Tribal",28:"Individual",29:"Collective",30:"Collective",31:"Collective",32:"Tribal",
  33:"Collective",34:"Individual",35:"Collective",36:"Collective",37:"Tribal",38:"Individual",39:"Individual",40:"Tribal",
  41:"Collective",42:"Collective",43:"Individual",44:"Tribal",45:"Tribal",46:"Collective",47:"Collective",48:"Collective",
  49:"Tribal",50:"Tribal",51:"Individual",52:"Collective",53:"Collective",54:"Tribal",55:"Individual",56:"Collective",
  57:"Integration",58:"Collective",59:"Tribal",60:"Individual",61:"Individual",62:"Collective",63:"Collective",64:"Collective"
}

GATE_NAMES = {
  1:"The Creative",2:"The Receptive",3:"Difficulty at the Beginning",4:"Youthful Folly",
  5:"Waiting",6:"Conflict",7:"The Army",8:"Holding Together",9:"Taming Power of the Small",
  10:"Treading",11:"Peace",12:"Standstill",13:"Fellowship of Man",14:"Possession in Great Measure",
  15:"Modesty",16:"Enthusiasm",17:"Following",18:"Work on What Has Been Spoilt",19:"Approach",
  20:"Contemplation",21:"Biting Through",22:"Grace",23:"Splitting Apart",24:"Returning",
  25:"Innocence",26:"Taming Power of the Great",27:"Nourishment",28:"Preponderance of the Great",
  29:"The Abysmal",30:"The Clinging Fire",31:"Influence",32:"Duration",33:"Retreat",
  34:"Power of the Great",35:"Progress",36:"Darkening of the Light",37:"The Family",
  38:"Opposition",39:"Obstruction",40:"Deliverance",41:"Decrease",42:"Increase",
  43:"Breakthrough",44:"Coming to Meet",45:"Gathering Together",46:"Pushing Upward",
  47:"Oppression",48:"The Well",49:"Revolution",50:"The Cauldron",51:"The Arousing",
  52:"Keeping Still",53:"Development",54:"The Marrying Maiden",55:"Abundance",
  56:"The Wanderer",57:"The Gentle",58:"The Joyous",59:"Dispersion",60:"Limitation",
  61:"Inner Truth",62:"Preponderance of the Small",63:"After Completion",64:"Before Completion"
}

TRIA_PRIMA = {
  "sulfur": {"name":"Sulfur","symbol":"üúç","element":"fire","centers":["G","Heart","Solar Plexus"]},
  "mercury_tp": {"name":"Mercury","symbol":"‚òø","element":"air","centers":["Head","Ajna","Throat"]},
  "salt": {"name":"Salt","symbol":"üúî","element":"earth","centers":["Spleen","Sacral","Root"]},
}

OPUS_PHASES = ["nigredo","albedo","citrinitas","rubedo"]

LINE_KEYWORDS = {
  1:("Foundation","Investigator","introspection,research,building"),
  2:("Hermit","Natural","projection,talent,calling"),
  3:("Martyr","Trial & Error","adaptation,resilience,discovery"),
  4:("Opportunist","Network","influence,community,friendship"),
  5:("Heretic","Universalizer","projection,universality,solutions"),
  6:("Role Model","Sage","objectivity,wisdom,embodiment"),
}

COLOR_NAMES = {1:"Determined",2:"Receptive",3:"Martyr",4:"Opportunist",5:"Seeker",6:"Syncretic"}
TONE_NAMES  = {1:"Innocence",2:"Cyclical",3:"Attunement",4:"Memory",5:"Passion",6:"PURPOSE"}
BASE_NAMES  = {1:"Movement",2:"Evolution",3:"Being",4:"Form",5:"Quintessence"}

BASE_VOICES = {1:"I Define",2:"I Remember",3:"I Am",4:"I Become",5:"I Know"}

def calc_film(sun_gate: int, sun_line: int):
    seed = (sun_gate * 7 + sun_line * 13) % 97
    gamma = 1.0 + ((seed % 11) - 5) / 50.0
    beta  = ((seed % 7) - 3) / 20.0
    return {"gamma":gamma,"beta":beta,"sunGate":sun_gate,"sunLine":sun_line,"seed":seed}

def graph_sage_pass(activated: set, channel_edges: list) -> Dict[int,float]:
    """Simple GraphSAGE-inspired message passing (no torch needed)."""
    # Build adjacency
    adj = {i:[] for i in range(1,65)}
    for a,b in channel_edges:
        adj[a].append(b)
        adj[b].append(a)
    
    # Node features: 1.0 if activated else 0.1
    x = {i: (1.0 if i in activated else 0.1) for i in range(1,65)}
    
    # 3 rounds of message passing (mean aggregation)
    for _ in range(3):
        x_new = {}
        for node in range(1,65):
            neigh = adj[node]
            if neigh:
                neigh_mean = sum(x[n] for n in neigh) / len(neigh)
            else:
                neigh_mean = 0.0
            # Combine self + neighbor
            x_new[node] = (0.5 * x[node] + 0.5 * neigh_mean)
        x = x_new
    return x

def awareness_pool(node_scores: Dict[int,float], gate_set: set, film_gamma=1.0, film_beta=0.0) -> float:
    """Attention-pooled awareness score with FiLM modulation."""
    vals = [node_scores.get(g,0) for g in gate_set]
    if not vals: return 0.0
    # Softmax-weighted sum approximation
    import math
    exp_vals = [math.exp(v * 5) for v in vals]
    total = sum(exp_vals)
    attn = [e/total for e in exp_vals]
    pooled = sum(a*v for a,v in zip(attn,vals))
    modulated = max(0.0, min(1.0, film_gamma * pooled + film_beta))
    return modulated

def analyze_chart(placements_json: str) -> str:
    data = json.loads(placements_json)
    placements_list = data["placements"]
    transit_sun = data.get("transitSun")
    
    activated_gates = set()
    planet_to_idx = {p:i for i,p in enumerate(PLANETS)}
    
    for p in placements_list:
        activated_gates.add(p["gate"])
    
    # Body Sun for FiLM
    body_sun_gate, body_sun_line = 1, 1
    if transit_sun:
        body_sun_gate = transit_sun["gate"]
        body_sun_line = transit_sun["line"]
    else:
        for p in placements_list:
            if p["planet"] == "Sun" and p["stream"] == "body":
                body_sun_gate = p["gate"]
                body_sun_line = p["line"]
                break
    
    film = calc_film(body_sun_gate, body_sun_line)
    
    # Channel definitions
    defined_channels = []
    channel_defined_gates = set()
    for a,b in CHANNEL_EDGES:
        if a in activated_gates and b in activated_gates:
            defined_channels.append([a,b])
            channel_defined_gates.add(a)
            channel_defined_gates.add(b)
    
    # GraphSAGE message passing
    node_scores = graph_sage_pass(activated_gates, CHANNEL_EDGES)
    
    # Build codons
    codons = []
    for gate_id in range(1,65):
        raw_score = node_scores.get(gate_id, 0.1)
        # FiLM modulate activated gates
        if gate_id in activated_gates:
            score = max(0, min(1, film["gamma"] * raw_score + film["beta"]))
        else:
            score = raw_score * 0.3
        codons.append({
            "gate": gate_id,
            "score": round(score, 4),
            "name": GATE_NAMES.get(gate_id,""),
            "center": GATE_TO_CENTER.get(gate_id,""),
            "circuitGroup": GATE_CIRCUIT.get(gate_id,""),
            "isActivated": gate_id in activated_gates,
            "definedByPlacement": gate_id in activated_gates,
            "definedByChannel": gate_id in channel_defined_gates,
        })
    
    # Awareness scores
    def calc_awareness(atype, gate_set):
        active = [g for g in gate_set if g in activated_gates]
        base = awareness_pool(node_scores, gate_set, film["gamma"], film["beta"])
        return {"type":atype,"score":round(base,4),"activatedGates":active}
    
    awareness = {
        "spleen":      calc_awareness("spleen", AWARENESS_SETS["spleen"]),
        "ajna":        calc_awareness("ajna",   AWARENESS_SETS["ajna"]),
        "solar_plexus":calc_awareness("solar_plexus", AWARENESS_SETS["solar_plexus"]),
    }
    
    # Modulators
    def calc_modulator(gate_set, label):
        active = [g for g in gate_set if g in activated_gates]
        base_vals = [node_scores.get(g,0) for g in active] if active else [0.1]
        base_score = sum(base_vals)/len(base_vals)
        score = max(0.0, min(1.0, film["gamma"]*base_score + film["beta"]))
        return {
            "score": round(score,4),
            "baseScore": round(base_score,4),
            "filmParams": film,
            "rationale": f"FiLM: Œ≥={film['gamma']:.3f}, Œ≤={film['beta']:.3f} via seed {film['seed']} from Gate {body_sun_gate}.{body_sun_line}",
        }
    
    heart = calc_modulator(HEART_GATES,"heart")
    mind  = calc_modulator(MIND_GATES, "mind")
    
    # Tria Prima
    def tria_prima_score(centers):
        vals = [c["score"] for c in codons if c["center"] in centers and c["isActivated"]]
        return round(sum(vals)/len(vals),4) if vals else 0.0
    
    tria = {
        "sulfur":  tria_prima_score(TRIA_PRIMA["sulfur"]["centers"]),
        "mercury": tria_prima_score(TRIA_PRIMA["mercury_tp"]["centers"]),
        "salt":    tria_prima_score(TRIA_PRIMA["salt"]["centers"]),
    }
    
    # Interaction
    vals = [("mind",tria["mercury"]),("heart",tria["sulfur"]),("body",tria["salt"])]
    vals.sort(key=lambda x:-x[1])
    leader = vals[0][0]
    
    mh = abs(tria["mercury"]-tria["sulfur"])
    hb = abs(tria["sulfur"]-tria["salt"])
    mb = abs(tria["mercury"]-tria["salt"])
    avg = (mh+hb+mb)/3
    
    if avg < 0.15: outcome = "coherence"
    elif avg < 0.35: outcome = "mediated"
    else: outcome = "conflict"
    
    triad = (tria["sulfur"]+tria["mercury"]+tria["salt"])/3
    interaction = {"leader":leader,"outcome":outcome,"triad":round(triad,4),"couplings":{"mind_heart":round(mh,4),"heart_body":round(hb,4),"mind_body":round(mb,4)}}
    
    total_t = tria["sulfur"]+tria["mercury"]+tria["salt"]
    if total_t < 0.5 or outcome=="conflict": opus = "nigredo"
    elif total_t < 1.2: opus = "albedo"
    elif total_t < 2.0: opus = "citrinitas"
    else: opus = "rubedo"
    
    # Resonance sentences (simplified from sentence-engine.ts)
    def gen_sentence(p):
        gate = p["gate"]; line = p["line"]
        stream_label = "Design" if p["stream"]=="design" else "Body"
        color = ((gate * line) % 6) + 1
        tone  = ((gate + line * 3) % 6) + 1
        base  = ((gate * 3 + line) % 5) + 1
        
        line_kw = LINE_KEYWORDS.get(line,("?","?","?"))
        color_name = COLOR_NAMES.get(color,"?")
        tone_name  = TONE_NAMES.get(tone,"?")
        base_name  = BASE_NAMES.get(base,"?")
        base_voice = BASE_VOICES.get(base,"I Am")
        
        gate_name = GATE_NAMES.get(gate, f"Gate {gate}")
        center    = GATE_TO_CENTER.get(gate,"?")
        
        sentence = f"{base_voice} the {line_kw[0]} of {gate_name} ({center}), expressing {color_name} awareness through {tone_name} resonance, in the field of {base_name}."
        return {
            "sentence": sentence,
            "planet": p["planet"],
            "stream": stream_label,
            "gate": gate,
            "line": line,
            "color": color,
            "tone": tone,
            "base": base,
            "center": center,
        }
    
    sentences = [gen_sentence(p) for p in placements_list]
    
    result = {
        "codons": codons,
        "awareness": awareness,
        "heart": heart,
        "mind": mind,
        "definedChannels": defined_channels,
        "alchemy": {"triaPrima":tria,"opusPhase":opus,"interaction":interaction},
        "sentences": sentences,
        "bodySun": {"gate":body_sun_gate,"line":body_sun_line},
    }
    return json.dumps(result)

print("ENGINE_READY")
`;

// ============================================================
// INIT PYODIDE
// ============================================================
async function initPyodide() {
  setStatus("Loading Pyodide runtime‚Ä¶");
  try {
    pyodide = await loadPyodide();
    setStatus("Initializing causal graph engine‚Ä¶");
    const result = await pyodide.runPythonAsync(PYTHON_ENGINE);
    setStatus("Running test analysis‚Ä¶");
    document.getElementById("loader-status").textContent = "‚úì Engine ready";
    setTimeout(() => {
      document.getElementById("loader").style.display = "none";
      document.getElementById("app").classList.remove("hidden");
      renderPlacements();
      drawGraph("graph-svg", [], []);
    }, 400);
  } catch(e) {
    document.getElementById("loader-status").textContent = "Error: " + e.message;
    console.error(e);
  }
}

function setStatus(msg) {
  document.getElementById("loader-status").textContent = msg;
}

// ============================================================
// PLACEMENT FORM
// ============================================================
function renderPlacements() {
  const list = document.getElementById("placements-list");
  list.innerHTML = "";
  placements.forEach((p, i) => {
    const row = document.createElement("div");
    row.className = "placement-row";
    row.innerHTML = `
      <select onchange="updateP(${i},'planet',this.value)">
        ${PLANETS.map(pl=>`<option value="${pl}" ${pl===p.planet?"selected":""}>${pl}</option>`).join("")}
      </select>
      <select onchange="updateP(${i},'stream',this.value)">
        ${STREAMS.map(s=>`<option value="${s}" ${s===p.stream?"selected":""}>${s}</option>`).join("")}
      </select>
      <input type="number" value="${p.gate}" min="1" max="64" onchange="updateP(${i},'gate',+this.value)">
      <input type="number" value="${p.line}" min="1" max="6" onchange="updateP(${i},'line',+this.value)">
      <button class="remove-btn" onclick="removeP(${i})">√ó</button>
    `;
    list.appendChild(row);
  });
}

function updateP(i, field, val) { placements[i][field] = val; }
function removeP(i) { placements.splice(i,1); renderPlacements(); }
function addPlacement() {
  placements.push({planet:"Mercury",stream:"body",gate:1,line:1});
  renderPlacements();
}
function toggleTransit() {
  const on = document.getElementById("use-transit").checked;
  const inputs = document.getElementById("transit-inputs");
  inputs.style.display = on ? "flex" : "none";
}

// ============================================================
// GRAPH DRAWING (SVG, no canvas)
// ============================================================
function getGatePositions() {
  const positions = {};
  const gatesByCenter = {};
  GATE_DATA.forEach(g => {
    if(!gatesByCenter[g.center]) gatesByCenter[g.center] = [];
    gatesByCenter[g.center].push(g.id);
  });
  GATE_DATA.forEach(g => {
    const cp = CENTER_POSITIONS[g.center];
    const list = gatesByCenter[g.center];
    const idx = list.indexOf(g.id);
    const total = list.length;
    let ox = 0, oy = 0;
    if(total > 1) {
      const row = Math.floor(idx / 4);
      const col = idx % 4;
      const cols = Math.min(total, 4);
      ox = (col - (cols-1)/2) * 14;
      oy = (row - Math.floor((total-1)/8)) * 14;
    }
    positions[g.id] = {x: cp.x + ox, y: cp.y + oy};
  });
  return positions;
}

const GATE_POSITIONS = getGatePositions();

function drawGraph(svgId, activatedGates, definedChannels) {
  const svg = document.getElementById(svgId);
  svg.innerHTML = "";
  const ns = "http://www.w3.org/2000/svg";

  const definedSet = new Set(definedChannels.map(([a,b])=>`${Math.min(a,b)}-${Math.max(a,b)}`));
  const activatedSet = new Set(activatedGates);
  const codonScores = chartData ? new Map(chartData.codons.map(c=>[c.gate,c])) : new Map();

  // Center backgrounds
  Object.entries(CENTER_POSITIONS).forEach(([name, pos]) => {
    const el = document.createElementNS(ns,"ellipse");
    el.setAttribute("cx",pos.x); el.setAttribute("cy",pos.y);
    el.setAttribute("rx",52); el.setAttribute("ry",36);
    el.setAttribute("fill",CENTER_COLORS[name]+"18");
    el.setAttribute("stroke",CENTER_COLORS[name]);
    el.setAttribute("stroke-width","1"); el.setAttribute("stroke-opacity","0.25");
    svg.appendChild(el);

    const label = document.createElementNS(ns,"text");
    label.setAttribute("x",pos.x); label.setAttribute("y",pos.y-42);
    label.setAttribute("text-anchor","middle");
    label.setAttribute("fill",CENTER_COLORS[name]);
    label.setAttribute("font-size","9");
    label.setAttribute("font-weight","600");
    label.textContent = name;
    svg.appendChild(label);
  });

  // Channel edges
  CHANNEL_EDGES.forEach(([from,to]) => {
    const fp = GATE_POSITIONS[from], tp = GATE_POSITIONS[to];
    if(!fp||!tp) return;
    const key = `${Math.min(from,to)}-${Math.max(from,to)}`;
    const isDefined = definedSet.has(key);
    const line = document.createElementNS(ns,"line");
    line.setAttribute("x1",fp.x); line.setAttribute("y1",fp.y);
    line.setAttribute("x2",tp.x); line.setAttribute("y2",tp.y);
    line.setAttribute("stroke", isDefined ? "#c084fc" : "#2a1a42");
    line.setAttribute("stroke-width", isDefined ? "2.5" : "1");
    line.setAttribute("stroke-opacity", isDefined ? "0.85" : "0.4");
    svg.appendChild(line);
  });

  // Gate nodes
  GATE_DATA.forEach(gate => {
    const pos = GATE_POSITIONS[gate.id];
    if(!pos) return;
    const isAct = activatedSet.has(gate.id);
    const codon = codonScores.get(gate.id);
    const score = codon ? codon.score : 0;
    const color = CENTER_COLORS[gate.center] || "#7c3aed";
    const radius = isAct ? 7 + score*4 : 5;

    const g = document.createElementNS(ns,"g");
    g.style.cursor = "pointer";

    if(isAct) {
      const pulse = document.createElementNS(ns,"circle");
      pulse.setAttribute("cx",pos.x); pulse.setAttribute("cy",pos.y);
      pulse.setAttribute("r",radius+4);
      pulse.setAttribute("fill","none");
      pulse.setAttribute("stroke",color);
      pulse.setAttribute("stroke-width","1");
      pulse.setAttribute("opacity","0.2");
      g.appendChild(pulse);
    }

    const circle = document.createElementNS(ns,"circle");
    circle.setAttribute("cx",pos.x); circle.setAttribute("cy",pos.y);
    circle.setAttribute("r",radius);
    circle.setAttribute("fill", isAct ? color : "#1a0f28");
    circle.setAttribute("stroke", isAct ? color : "#2a1a42");
    circle.setAttribute("stroke-width","1");
    circle.setAttribute("opacity", isAct ? "0.9":"0.5");
    g.appendChild(circle);

    const text = document.createElementNS(ns,"text");
    text.setAttribute("x",pos.x); text.setAttribute("y",pos.y+3);
    text.setAttribute("text-anchor","middle");
    text.setAttribute("fill", isAct ? "white":"#8b7aa8");
    text.setAttribute("font-size","6");
    text.setAttribute("font-weight","700");
    text.setAttribute("pointer-events","none");
    text.textContent = gate.id;
    g.appendChild(text);

    g.addEventListener("mouseenter", (e) => showTooltip(e, gate, codon));
    g.addEventListener("mousemove",  (e) => moveTooltip(e));
    g.addEventListener("mouseleave", hideTooltip);
    svg.appendChild(g);
  });

  // Zoom wrapper
  svg.style.transform = `scale(${graphZoom})`;
  svg.style.transformOrigin = "top center";
}

function zoomGraph(delta) { graphZoom = Math.max(0.5, Math.min(2, graphZoom + delta)); redrawGraphs(); }
function resetZoom() { graphZoom = 1; redrawGraphs(); }
function redrawGraphs() {
  const activated = placements.map(p=>p.gate);
  const defined = chartData ? chartData.definedChannels : [];
  drawGraph("graph-svg", activated, defined);
  if(chartData) drawGraph("graph-svg-results", activated, defined);
}

// ============================================================
// TOOLTIP
// ============================================================
function showTooltip(e, gate, codon) {
  const tt = document.getElementById("tooltip");
  tt.innerHTML = `<strong>Gate ${gate.id}</strong> ‚Äî ${gate.name}<br>
    <span class="tt-sub">${gate.center} ¬∑ ${gate.circuitGroup}</span>
    ${codon ? `<br><span class="tt-sub">Score: ${codon.score.toFixed(3)} ${codon.isActivated?"¬∑ ‚ú¶ Activated":""}</span>` : ""}`;
  tt.style.display = "block";
  moveTooltip(e);
}
function moveTooltip(e) {
  const tt = document.getElementById("tooltip");
  tt.style.left = (e.clientX + 14) + "px";
  tt.style.top  = (e.clientY - 10) + "px";
}
function hideTooltip() { document.getElementById("tooltip").style.display = "none"; }

// ============================================================
// ANALYZE CHART (Pyodide Python)
// ============================================================
async function analyzeChart() {
  const btn = document.getElementById("btn-analyze");
  btn.disabled = true;
  btn.textContent = "Analyzing‚Ä¶";

  const useTransit = document.getElementById("use-transit").checked;
  const payload = {
    placements: placements.map(p=>({...p})),
    transitSun: useTransit ? {
      gate: parseInt(document.getElementById("transit-gate").value),
      line: parseInt(document.getElementById("transit-line").value)
    } : null
  };

  try {
    const json_str = JSON.stringify(payload);
    pyodide.globals.set("_payload", json_str);
    const result = await pyodide.runPythonAsync(`analyze_chart(_payload)`);
    chartData = JSON.parse(result);
    renderResults();
  } catch(e) {
    console.error(e);
    alert("Analysis error: " + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "‚ú¶ Analyze Chart";
  }
}

// ============================================================
// RENDER RESULTS
// ============================================================
function renderResults() {
  if(!chartData) return;

  // Show/hide sections
  document.getElementById("results-section").classList.remove("hidden");
  document.getElementById("btn-new").style.display = "";
  document.getElementById("btn-export").style.display = "";

  const activated = placements.map(p=>p.gate);

  // Badges
  const actGates = chartData.codons.filter(c=>c.isActivated).length;
  document.getElementById("badge-gates").textContent = `${actGates} gates`;
  document.getElementById("badge-channels").textContent = `${chartData.definedChannels.length} channels`;
  document.getElementById("body-sun-label").textContent = `Body Sun: Gate ${chartData.bodySun.gate}.${chartData.bodySun.line}`;

  // Graphs
  drawGraph("graph-svg", activated, chartData.definedChannels);
  drawGraph("graph-svg-results", activated, chartData.definedChannels);

  // Codon grid
  renderCodonGrid();

  // Awareness
  renderAwareness();

  // Modulators
  renderModulators();

  // Alchemy
  renderAlchemy();

  // Sentences
  renderSentences();

  // Narrative
  renderNarrative();

  // Scroll to results
  document.getElementById("results-section").scrollIntoView({behavior:"smooth"});
}

function renderCodonGrid() {
  const grid = document.getElementById("codon-grid");
  grid.innerHTML = "";
  chartData.codons.forEach(codon => {
    const color = CENTER_COLORS[codon.center] || "#7c3aed";
    const opacity = codon.isActivated ? Math.max(0.3, codon.score) : 0.08;
    const cell = document.createElement("div");
    cell.className = "codon-cell" + (codon.isActivated?" activated":"");
    cell.style.background = codon.isActivated ? `${color}${Math.round(opacity*255).toString(16).padStart(2,'0')}` : "var(--bg)";
    cell.style.borderColor = codon.isActivated ? color+"60" : "var(--border)";
    cell.title = `Gate ${codon.gate}: ${codon.name}\n${codon.center} ¬∑ Score: ${codon.score.toFixed(3)}`;
    cell.innerHTML = `
      <div class="codon-num" style="color:${codon.isActivated?color:"var(--muted)"}">${codon.gate}</div>
      <div class="codon-score">${codon.score.toFixed(2)}</div>
    `;
    grid.appendChild(cell);
  });
}

function renderAwareness() {
  const grid = document.getElementById("awareness-grid");
  grid.innerHTML = "";
  const types = [
    {key:"spleen",   label:"Spleen",      color:"var(--spleen-c)",  icon:"‚óâ"},
    {key:"ajna",     label:"Ajna Mind",   color:"var(--ajna-c)",    icon:"‚óà"},
    {key:"solar_plexus",label:"Solar Plexus",color:"var(--solar-c)", icon:"‚óÜ"},
  ];
  types.forEach(t => {
    const aw = chartData.awareness[t.key];
    const pct = (aw.score*100).toFixed(1);
    const gates = t.key==="spleen"? [57,44,50,32,28,18] : t.key==="ajna"? [47,24,4,17,11,43] : [55,49,37,22,30,36,6];
    const activatedSet = new Set(aw.activatedGates);
    const card = document.createElement("div");
    card.className = "awareness-card";
    card.innerHTML = `
      <div class="awareness-label" style="color:${t.color}">${t.icon} ${t.label} Awareness</div>
      <div class="awareness-score" style="color:${t.color}">${pct}%</div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${pct}%;background:${t.color}"></div></div>
      <div class="gates-row">
        ${gates.map(g=>`<div class="gate-pill${activatedSet.has(g)?" active":""}">${g}</div>`).join("")}
      </div>
    `;
    grid.appendChild(card);
  });
}

function renderModulators() {
  const body = document.getElementById("modulators-body");
  const fp = chartData.heart.filmParams;

  const renderMod = (label, mod, color, icon) => `
    <div style="margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-size:13px;font-weight:600;color:${color}">${icon} ${label}</div>
        <div style="font-size:20px;font-weight:700;color:${color}">${(mod.score*100).toFixed(1)}%</div>
      </div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${mod.score*100}%;background:${color}"></div></div>
      <div class="film-params">
        <div class="film-param"><div class="param-name">Œ≥ (gamma)</div><div class="param-val">${mod.filmParams.gamma.toFixed(3)}</div></div>
        <div class="film-param"><div class="param-name">Œ≤ (beta)</div><div class="param-val">${mod.filmParams.beta.toFixed(3)}</div></div>
        <div class="film-param"><div class="param-name">Seed</div><div class="param-val">${mod.filmParams.seed}</div></div>
        <div class="film-param"><div class="param-name">Base Score</div><div class="param-val">${mod.baseScore.toFixed(3)}</div></div>
      </div>
    </div>
  `;
  body.innerHTML = renderMod("Heart", chartData.heart, "var(--heart-c)", "‚ô•") +
                   `<hr style="border:none;border-top:1px solid var(--border);margin:14px 0">` +
                   renderMod("Mind", chartData.mind, "var(--ajna-c)", "‚óà");
}

const OPUS_COLORS = {nigredo:"#6b7280",albedo:"#e2e8f0",citrinitas:"#fbbf24",rubedo:"#ef4444"};
const OPUS_SYMBOLS = {nigredo:"‚¨õ",albedo:"‚¨ú",citrinitas:"üü°",rubedo:"üî¥"};

function renderAlchemy() {
  const body = document.getElementById("alchemy-body");
  const al = chartData.alchemy;
  const tp = al.triaPrima;
  const phase = al.opusPhase;
  const inter = al.interaction;
  const phaseColor = OPUS_COLORS[phase] || "var(--muted)";

  body.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <div class="phase-badge" style="border-color:${phaseColor}40;color:${phaseColor}">
        ${OPUS_SYMBOLS[phase]} ${phase.charAt(0).toUpperCase()+phase.slice(1)}
      </div>
      <span style="font-size:12px;color:var(--muted)">Opus Phase</span>
    </div>
    <div class="tria-grid">
      <div class="tria-card">
        <div class="tria-symbol">üúç</div>
        <div class="tria-name">Sulfur ¬∑ Fire</div>
        <div class="tria-score" style="color:#fb923c">${(tp.sulfur*100).toFixed(1)}%</div>
        <div style="font-size:10px;color:var(--muted)">G ¬∑ Heart ¬∑ Solar Plexus</div>
      </div>
      <div class="tria-card">
        <div class="tria-symbol">‚òø</div>
        <div class="tria-name">Mercury ¬∑ Air</div>
        <div class="tria-score" style="color:var(--ajna-c)">${(tp.mercury*100).toFixed(1)}%</div>
        <div style="font-size:10px;color:var(--muted)">Head ¬∑ Ajna ¬∑ Throat</div>
      </div>
      <div class="tria-card">
        <div class="tria-symbol">üúî</div>
        <div class="tria-name">Salt ¬∑ Earth</div>
        <div class="tria-score" style="color:var(--spleen-c)">${(tp.salt*100).toFixed(1)}%</div>
        <div style="font-size:10px;color:var(--muted)">Spleen ¬∑ Sacral ¬∑ Root</div>
      </div>
    </div>
    <div style="margin-top:14px;background:var(--bg);border-radius:8px;padding:10px;border:1px solid var(--border)">
      <div style="font-size:12px;margin-bottom:6px">
        <strong style="color:var(--primary)">Interaction:</strong>
        Leader: <span style="color:var(--text);font-weight:600">${inter.leader}</span> ¬∑
        Outcome: <span style="color:${inter.outcome==="coherence"?"var(--green)":inter.outcome==="mediated"?"var(--gold)":"var(--red)";}">${inter.outcome}</span> ¬∑
        Triad: <span style="color:var(--text)">${(inter.triad*100).toFixed(1)}%</span>
      </div>
      <div class="coupling-val">
        Mind‚ÜîHeart: <span>${inter.couplings.mind_heart.toFixed(3)}</span> ¬∑
        Heart‚ÜîBody: <span>${inter.couplings.heart_body.toFixed(3)}</span> ¬∑
        Mind‚ÜîBody: <span>${inter.couplings.mind_body.toFixed(3)}</span>
      </div>
    </div>
  `;
}

function renderSentences() {
  const list = document.getElementById("sentence-list");
  list.innerHTML = "";
  (chartData.sentences || []).forEach(s => {
    const item = document.createElement("div");
    item.className = "sentence-item";
    item.innerHTML = `
      <div class="sentence-text">"${s.sentence}"</div>
      <div class="sentence-meta">
        ${s.planet} (${s.stream}) ¬∑ Gate ${s.gate}.${s.line} ¬∑ ${s.center} ¬∑
        Color ${s.color} ¬∑ Tone ${s.tone} ¬∑ Base ${s.base}
      </div>
    `;
    list.appendChild(item);
  });
}

function renderNarrative() {
  const panel = document.getElementById("narrative-panel");
  const al = chartData.alchemy;
  const inter = al.interaction;
  const topAwareness = ["spleen","ajna","solar_plexus"]
    .map(k=>({k,s:chartData.awareness[k].score}))
    .sort((a,b)=>b.s-a.s)[0];
  const activated = chartData.codons.filter(c=>c.isActivated).length;
  const phase = al.opusPhase;
  const phaseDesc = {
    nigredo:"in the initial dissolution ‚Äî tension between fields, potential unrealized",
    albedo:"entering purification ‚Äî patterns clarifying through the wash of awareness",
    citrinitas:"in the yellowing ‚Äî intellectual fire awakening the causal lattice",
    rubedo:"in full embodiment ‚Äî the red work, consciousness materialized into form"
  }[phase] || "traversing unknown territory";

  panel.textContent = `${activated} gates activated across the 64-codon graph. The causal lattice speaks through ${inter.leader} as primary conductor ‚Äî ${inter.outcome} emerges between the three fields. Tria Prima: sulfur at ${(al.triaPrima.sulfur*100).toFixed(0)}%, mercury at ${(al.triaPrima.mercury*100).toFixed(0)}%, salt at ${(al.triaPrima.salt*100).toFixed(0)}%. The dominant awareness is ${topAwareness.k} (${(topAwareness.s*100).toFixed(1)}%). ${chartData.definedChannels.length} channels defined, carrying life force between activated centers. The chart is currently ${phaseDesc}. FiLM modulation seeded from Gate ${chartData.bodySun.gate}.${chartData.bodySun.line} with Œ≥=${chartData.heart.filmParams.gamma.toFixed(3)}, shaping the resonance field across all active nodes.`;
}

// ============================================================
// UTIL
// ============================================================
function resetChart() {
  chartData = null;
  document.getElementById("results-section").classList.add("hidden");
  document.getElementById("btn-new").style.display = "none";
  document.getElementById("btn-export").style.display = "none";
  drawGraph("graph-svg", placements.map(p=>p.gate), []);
}

function exportJSON() {
  if(!chartData) return;
  const blob = new Blob([JSON.stringify(chartData,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `hd-chart-${Date.now()}.json`;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}

// Start
initPyodide();
</script>
</body>
</html>
