<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SYNTHAI — Three Brain System</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap');

:root {
  --bg: #080a0f;
  --bg2: #0d1017;
  --surface: #111520;
  --surface2: #161b28;
  --border: #1e2535;
  --border2: #252e42;
  --text: #dde4f0;
  --text2: #7a8aaa;
  --text3: #3d4d6a;
  --b1: #f0a500;      /* Brain 1 - Inside/LoRA - amber */
  --b2: #3ecfcf;      /* Brain 2 - Outside/Claude - cyan */
  --b3: #a78bfa;      /* Brain 3 - Observer - violet */
  --success: #34d399;
  --error: #f87171;
  --glow1: rgba(240,165,0,0.15);
  --glow2: rgba(62,207,207,0.15);
  --glow3: rgba(167,139,250,0.15);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  height: 100dvh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ── NOISE OVERLAY ── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 1000;
  opacity: 0.4;
}

/* ── HEADER ── */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: 52px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
  gap: 12px;
}

.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.1em;
  letter-spacing: 3px;
  background: linear-gradient(90deg, var(--b1), var(--b2), var(--b3));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  white-space: nowrap;
}

.brain-indicators {
  display: flex;
  gap: 10px;
  align-items: center;
}

.brain-dot {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.65em;
  color: var(--text3);
  letter-spacing: 1px;
}

.brain-dot-pulse {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--text3);
  transition: background 0.3s, box-shadow 0.3s;
}

.brain-dot-pulse.active {
  animation: pulse 2s ease-in-out infinite;
}

.brain-dot-pulse.b1 { background: var(--b1); box-shadow: 0 0 8px var(--b1); }
.brain-dot-pulse.b2 { background: var(--b2); box-shadow: 0 0 8px var(--b2); }
.brain-dot-pulse.b3 { background: var(--b3); box-shadow: 0 0 8px var(--b3); }

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.8); }
}

.header-btn {
  background: none;
  border: 1px solid var(--border2);
  color: var(--text2);
  padding: 6px 12px;
  border-radius: 6px;
  font-family: 'Space Mono', monospace;
  font-size: 0.7em;
  cursor: pointer;
  letter-spacing: 1px;
  transition: all 0.2s;
  white-space: nowrap;
}
.header-btn:hover { border-color: var(--b2); color: var(--b2); }

/* ── MAIN LAYOUT ── */
.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ── SIDEBAR ── */
.sidebar {
  width: 260px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
  background: var(--bg2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width 0.3s;
}

.sidebar.collapsed { width: 0; overflow: hidden; }

.sidebar-section {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}

.sidebar-label {
  font-size: 0.6em;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  margin-bottom: 10px;
}

/* ── BRAIN STATUS CARDS ── */
.brain-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 8px;
  transition: all 0.3s;
}

.brain-card.firing {
  border-color: var(--border2);
  box-shadow: 0 0 12px var(--glow2);
}

.brain-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.brain-card-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.brain-card-name {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 0.75em;
  letter-spacing: 1px;
}

.brain-card-role {
  font-size: 0.6em;
  color: var(--text3);
  letter-spacing: 1px;
  margin-left: auto;
}

.brain-card-status {
  font-size: 0.65em;
  color: var(--text2);
  line-height: 1.5;
}

.brain-card-bar {
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  margin-top: 8px;
  overflow: hidden;
}

.brain-card-fill {
  height: 100%;
  border-radius: 1px;
  transition: width 1s ease;
}

/* ── UPLOAD ZONE ── */
.upload-zone {
  border: 2px dashed var(--border2);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--surface);
}

.upload-zone:hover, .upload-zone.drag {
  border-color: var(--b2);
  background: rgba(62,207,207,0.04);
}

.upload-zone-icon { font-size: 1.5em; margin-bottom: 6px; display: block; }
.upload-zone-text { font-size: 0.65em; color: var(--text2); line-height: 1.6; }
.upload-zone-sub { font-size: 0.58em; color: var(--text3); margin-top: 4px; }

.uploaded-files { margin-top: 8px; max-height: 120px; overflow-y: auto; }

.uploaded-file {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 8px;
  background: var(--surface2);
  border-radius: 5px;
  margin-bottom: 4px;
  font-size: 0.62em;
}

.uploaded-file-type {
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 0.9em;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.type-model { background: rgba(240,165,0,0.15); color: var(--b1); }
.type-python { background: rgba(62,207,207,0.1); color: var(--b2); }
.type-json { background: rgba(167,139,250,0.1); color: var(--b3); }
.type-other { background: var(--border); color: var(--text3); }

.uploaded-file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text2); }
.uploaded-file-remove { background: none; border: none; color: var(--text3); cursor: pointer; padding: 0 2px; font-size: 1em; }
.uploaded-file-remove:hover { color: var(--error); }

/* ── OBSERVER LOG ── */
.observer-log {
  flex: 1;
  overflow-y: auto;
  padding: 10px 12px;
  font-size: 0.62em;
  color: var(--text3);
  line-height: 1.7;
}

.log-entry {
  padding: 3px 0;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 6px;
}

.log-time { color: var(--text3); flex-shrink: 0; }
.log-b1 { color: var(--b1); }
.log-b2 { color: var(--b2); }
.log-b3 { color: var(--b3); }

/* ── CHAT AREA ── */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

/* Scrollbar */
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.msg {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-width: 88%;
  animation: msgIn 0.25s ease;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user { align-self: flex-end; }
.msg.assistant { align-self: flex-start; }
.msg.system { align-self: center; max-width: 95%; }

.msg-meta {
  font-size: 0.6em;
  color: var(--text3);
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 4px;
}

.msg-brain-tag {
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 0.9em;
  letter-spacing: 0.5px;
}

.tag-b1 { background: rgba(240,165,0,0.15); color: var(--b1); }
.tag-b2 { background: rgba(62,207,207,0.1); color: var(--b2); }
.tag-b3 { background: rgba(167,139,250,0.1); color: var(--b3); }
.tag-user { background: var(--surface2); color: var(--text3); }

.msg-bubble {
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 0.85em;
  line-height: 1.65;
  word-wrap: break-word;
}

.msg.user .msg-bubble {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-bottom-right-radius: 3px;
  color: var(--text);
}

.msg.assistant .msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-bottom-left-radius: 3px;
}

.msg.assistant.b1 .msg-bubble { border-left: 2px solid var(--b1); }
.msg.assistant.b2 .msg-bubble { border-left: 2px solid var(--b2); }
.msg.assistant.b3 .msg-bubble { border-left: 2px solid var(--b3); }
.msg.assistant.synthesis .msg-bubble {
  border-left: 2px solid;
  border-image: linear-gradient(180deg, var(--b1), var(--b2), var(--b3)) 1;
}

.msg.system .msg-bubble {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 0.75em;
  text-align: center;
  padding: 4px;
}

/* Code blocks in messages */
.msg-bubble pre {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  margin: 8px 0;
  overflow-x: auto;
  font-size: 0.85em;
  line-height: 1.5;
}

.msg-bubble code {
  font-family: 'Space Mono', monospace;
  background: var(--surface2);
  padding: 1px 5px;
  border-radius: 3px;
  font-size: 0.9em;
}

.msg-bubble pre code { background: none; padding: 0; }

/* Copy button */
.code-copy {
  float: right;
  background: var(--surface2);
  border: 1px solid var(--border2);
  color: var(--text3);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: 'Space Mono', monospace;
  font-size: 0.75em;
  cursor: pointer;
  margin-left: 8px;
  transition: all 0.2s;
}
.code-copy:hover { color: var(--b2); border-color: var(--b2); }

/* ── THINKING INDICATOR ── */
.thinking {
  display: flex;
  gap: 6px;
  align-items: center;
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 2px solid var(--b3);
  border-radius: 12px;
  border-bottom-left-radius: 3px;
  font-size: 0.75em;
  color: var(--text3);
  align-self: flex-start;
  animation: msgIn 0.25s ease;
}

.thinking-dots {
  display: flex;
  gap: 3px;
}

.thinking-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--b3);
  animation: blink 1.2s ease-in-out infinite;
}

.thinking-dot:nth-child(2) { animation-delay: 0.2s; }
.thinking-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 100% { opacity: 0.2; }
  50% { opacity: 1; }
}

.thinking-label {
  color: var(--b3);
  font-size: 0.9em;
  letter-spacing: 1px;
}

/* ── INPUT BAR ── */
.input-bar {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.input-wrap {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 12px;
  display: flex;
  align-items: flex-end;
  padding: 2px 4px 2px 14px;
  transition: border-color 0.2s;
  gap: 6px;
}

.input-wrap:focus-within { border-color: var(--b2); }

.chat-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text);
  font-family: 'Space Mono', monospace;
  font-size: 0.85em;
  padding: 10px 0;
  resize: none;
  min-height: 40px;
  max-height: 120px;
  line-height: 1.5;
  outline: none;
}

.chat-input::placeholder { color: var(--text3); }

.send-btn {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--b2);
  border: none;
  color: var(--bg);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
  margin-bottom: 2px;
}

.send-btn:hover { background: #5ee0e0; }
.send-btn:disabled { background: var(--border2); color: var(--text3); cursor: not-allowed; }

.mode-btns {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 8px;
  padding: 0 2px;
}

.mode-btn {
  padding: 4px 10px;
  border-radius: 5px;
  border: 1px solid var(--border2);
  background: none;
  color: var(--text3);
  font-family: 'Space Mono', monospace;
  font-size: 0.62em;
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.2s;
}

.mode-btn:hover { color: var(--text2); border-color: var(--border2); }
.mode-btn.active { border-color: var(--b2); color: var(--b2); background: rgba(62,207,207,0.06); }

/* ── BOTTOM NAV ── */
.bottom-nav {
  display: flex;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  height: 52px;
  flex-shrink: 0;
}

.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  background: none;
  border: none;
  color: var(--text3);
  font-family: 'Space Mono', monospace;
  font-size: 0.58em;
  letter-spacing: 1px;
  cursor: pointer;
  transition: color 0.2s;
  padding: 6px;
}

.nav-btn.active { color: var(--b2); }
.nav-btn svg { width: 18px; height: 18px; margin-bottom: 1px; }

/* ── VIEWS ── */
.view { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.view.active { display: flex; }

/* ── UPLOAD VIEW ── */
#view-upload {
  overflow-y: auto;
  padding: 20px;
}

.upload-header {
  font-family: 'Syne', sans-serif;
  font-size: 1.3em;
  font-weight: 800;
  margin-bottom: 6px;
  color: var(--text);
}

.upload-sub {
  font-size: 0.72em;
  color: var(--text2);
  margin-bottom: 20px;
  line-height: 1.6;
}

.upload-big-zone {
  border: 2px dashed var(--border2);
  border-radius: 12px;
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--surface);
  margin-bottom: 16px;
}

.upload-big-zone:hover, .upload-big-zone.drag {
  border-color: var(--b2);
  background: rgba(62,207,207,0.04);
  box-shadow: 0 0 30px rgba(62,207,207,0.08);
}

.upload-big-icon { font-size: 2.5em; margin-bottom: 12px; display: block; }
.upload-big-title { font-family: 'Syne', sans-serif; font-size: 1em; font-weight: 700; margin-bottom: 6px; }
.upload-big-desc { font-size: 0.7em; color: var(--text2); line-height: 1.8; }
.upload-big-types { font-size: 0.62em; color: var(--text3); margin-top: 8px; }

.upload-categories {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 16px;
}

.upload-category {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
}

.upload-category-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.upload-category-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.upload-category-title {
  font-family: 'Syne', sans-serif;
  font-size: 0.8em;
  font-weight: 700;
}

.upload-category-desc {
  font-size: 0.62em;
  color: var(--text2);
  line-height: 1.6;
}

.upload-category-files {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.category-file {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.62em;
  color: var(--text2);
  padding: 4px 6px;
  background: var(--surface2);
  border-radius: 4px;
}

.category-file-status {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-loaded { background: var(--success); }
.status-pending { background: var(--text3); }

/* ── OBSERVER VIEW ── */
#view-observer {
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.observer-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.observer-title {
  font-family: 'Syne', sans-serif;
  font-size: 1em;
  font-weight: 700;
  color: var(--b3);
}

.observer-stats {
  display: flex;
  gap: 16px;
  font-size: 0.65em;
  color: var(--text3);
}

.observer-stat span {
  color: var(--b3);
}

.observer-full-log {
  flex: 1;
  overflow-y: auto;
  padding: 12px 20px;
  font-size: 0.7em;
  line-height: 1.8;
}

.observer-entry {
  display: grid;
  grid-template-columns: 70px 60px 1fr;
  gap: 10px;
  padding: 5px 0;
  border-bottom: 1px solid var(--border);
  align-items: start;
}

.obs-time { color: var(--text3); font-size: 0.85em; }
.obs-brain { font-weight: 700; font-size: 0.85em; }
.obs-text { color: var(--text2); }

.obs-pattern {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 2px solid var(--b3);
  border-radius: 6px;
  padding: 10px 14px;
  margin: 8px 0;
  font-size: 0.85em;
  color: var(--b3);
}

/* ── SCROLLBAR GLOBAL ── */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* ── MOBILE ── */
@media (max-width: 640px) {
  .sidebar { display: none; }
  .upload-categories { grid-template-columns: 1fr; }
  .brain-indicators .brain-dot span { display: none; }
}

/* ── COHERENCE BAR ── */
.coherence-strip {
  height: 2px;
  background: var(--border);
  flex-shrink: 0;
  overflow: hidden;
}

.coherence-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--b1), var(--b2), var(--b3));
  transition: width 2s ease;
}

/* ── EMPTY STATE ── */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: var(--text3);
  padding: 40px 20px;
  text-align: center;
}

.empty-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.1em;
  font-weight: 700;
  background: linear-gradient(90deg, var(--b1), var(--b2), var(--b3));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.empty-desc { font-size: 0.72em; color: var(--text3); line-height: 1.7; max-width: 320px; }

.quick-prompts {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 8px;
}

.quick-prompt {
  padding: 7px 14px;
  border: 1px solid var(--border2);
  border-radius: 20px;
  font-family: 'Space Mono', monospace;
  font-size: 0.68em;
  color: var(--text2);
  cursor: pointer;
  background: var(--surface);
  transition: all 0.2s;
}

.quick-prompt:hover { border-color: var(--b2); color: var(--b2); }

/* API key input */
.api-key-bar {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  gap: 8px;
  align-items: center;
}

.api-key-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border2);
  color: var(--text2);
  padding: 6px 10px;
  border-radius: 6px;
  font-family: 'Space Mono', monospace;
  font-size: 0.7em;
  outline: none;
}

.api-key-input:focus { border-color: var(--b2); }
.api-key-label { font-size: 0.65em; color: var(--text3); white-space: nowrap; letter-spacing: 1px; }
.api-key-save {
  background: var(--b2);
  border: none;
  color: var(--bg);
  padding: 6px 12px;
  border-radius: 6px;
  font-family: 'Space Mono', monospace;
  font-size: 0.65em;
  cursor: pointer;
  font-weight: 700;
  letter-spacing: 0.5px;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">SYNTHAI</div>
  <div class="brain-indicators">
    <div class="brain-dot">
      <div class="brain-dot-pulse b1 active" id="dot-b1"></div>
      <span>INSIDE</span>
    </div>
    <div class="brain-dot">
      <div class="brain-dot-pulse b2" id="dot-b2"></div>
      <span>OUTSIDE</span>
    </div>
    <div class="brain-dot">
      <div class="brain-dot-pulse b3 active" id="dot-b3"></div>
      <span>OBSERVER</span>
    </div>
  </div>
  <button class="header-btn" onclick="toggleSidebar()">⟨ BRAINS</button>
</div>

<!-- COHERENCE BAR -->
<div class="coherence-strip">
  <div class="coherence-fill" id="coherenceFill" style="width:0%"></div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">

    <!-- Brain Status -->
    <div class="sidebar-section">
      <div class="sidebar-label">Brain Status</div>

      <div class="brain-card" id="card-b1">
        <div class="brain-card-header">
          <div class="brain-card-dot" style="background:var(--b1);box-shadow:0 0 6px var(--b1)"></div>
          <div class="brain-card-name" style="color:var(--b1)">Brain 1</div>
          <div class="brain-card-role">INSIDE</div>
        </div>
        <div class="brain-card-status" id="status-b1">Your system. Deterministic. Holds your philosophy and LoRA knowledge.</div>
        <div class="brain-card-bar"><div class="brain-card-fill" id="fill-b1" style="width:60%;background:var(--b1)"></div></div>
      </div>

      <div class="brain-card" id="card-b2">
        <div class="brain-card-header">
          <div class="brain-card-dot" style="background:var(--b2);box-shadow:0 0 6px var(--b2)"></div>
          <div class="brain-card-name" style="color:var(--b2)">Brain 2</div>
          <div class="brain-card-role">OUTSIDE</div>
        </div>
        <div class="brain-card-status" id="status-b2">Claude + web search. Goes beyond the system. Seeks what isn't known.</div>
        <div class="brain-card-bar"><div class="brain-card-fill" id="fill-b2" style="width:0%;background:var(--b2)"></div></div>
      </div>

      <div class="brain-card" id="card-b3">
        <div class="brain-card-header">
          <div class="brain-card-dot" style="background:var(--b3);box-shadow:0 0 6px var(--b3)"></div>
          <div class="brain-card-name" style="color:var(--b3)">Brain 3</div>
          <div class="brain-card-role">OBSERVER</div>
        </div>
        <div class="brain-card-status" id="status-b3">Watches everything. Synthesizes. Learns from what Brain 2 does.</div>
        <div class="brain-card-bar"><div class="brain-card-fill" id="fill-b3" style="width:40%;background:var(--b3)"></div></div>
      </div>
    </div>

    <!-- Quick Upload -->
    <div class="sidebar-section">
      <div class="sidebar-label">Quick Upload</div>
      <div class="upload-zone" id="sidebarUpload" onclick="document.getElementById('hiddenInput').click()">
        <span class="upload-zone-icon">⬆</span>
        <div class="upload-zone-text">Drop files here<br>Models, Python, JSON</div>
        <div class="upload-zone-sub">Click or drag</div>
      </div>
      <div class="uploaded-files" id="uploadedFilesList"></div>
    </div>

    <!-- Observer Mini Log -->
    <div class="sidebar-label" style="padding:10px 16px 4px;">Observer Log</div>
    <div class="observer-log" id="observerMiniLog">
      <div style="color:var(--text3);font-size:0.95em;text-align:center;padding:10px 0;">Waiting for activity...</div>
    </div>

  </div>

  <!-- VIEWS CONTAINER -->
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">

    <!-- API KEY BAR -->
    <div class="api-key-bar" id="apiKeyBar">
      <span class="api-key-label">API KEY:</span>
      <input class="api-key-input" id="apiKeyInput" type="password" placeholder="sk-ant-... (paste your Anthropic API key)">
      <button class="api-key-save" onclick="saveApiKey()">SAVE</button>
    </div>

    <!-- CHAT VIEW -->
    <div class="view active" id="view-chat">
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state" id="emptyState">
          <div class="empty-title">THREE BRAINS. ONE SYSTEM.</div>
          <div class="empty-desc">Brain 1 holds your world. Brain 2 goes beyond it. Brain 3 watches both and learns. Start talking.</div>
          <div class="quick-prompts">
            <button class="quick-prompt" onclick="sendQuick('What am I?')">What am I?</button>
            <button class="quick-prompt" onclick="sendQuick('Show me what you know about my system')">Show my system</button>
            <button class="quick-prompt" onclick="sendQuick('What patterns have you observed?')">Observer patterns</button>
            <button class="quick-prompt" onclick="sendQuick('Search outside for something that resonates with my system')">Go outside</button>
          </div>
        </div>
      </div>

      <div style="padding:0 16px;">
        <div class="mode-btns">
          <button class="mode-btn active" id="mode-all" onclick="setMode('all')">ALL BRAINS</button>
          <button class="mode-btn" id="mode-b1" onclick="setMode('b1')">INSIDE ONLY</button>
          <button class="mode-btn" id="mode-b2" onclick="setMode('b2')">OUTSIDE ONLY</button>
          <button class="mode-btn" id="mode-observe" onclick="setMode('observe')">OBSERVE</button>
        </div>
      </div>

      <div class="input-bar">
        <div class="input-wrap">
          <textarea class="chat-input" id="chatInput" rows="1" placeholder="Talk to the system..."></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- UPLOAD VIEW -->
    <div class="view" id="view-upload">
      <div class="upload-header">Upload Your System</div>
      <div class="upload-sub">Drop everything here — models, Python files, JSON, docs. The app sorts it into the right brain automatically.</div>

      <div class="upload-big-zone" id="bigUpload" onclick="document.getElementById('hiddenInput').click()">
        <span class="upload-big-icon">⬆</span>
        <div class="upload-big-title">Drop Everything Here</div>
        <div class="upload-big-desc">
          Your LoRA weights, ONNX model, Python consciousness files,<br>
          training history, any docs or notes about your system
        </div>
        <div class="upload-big-types">.zip · .pt · .onnx · .safetensors · .py · .json · .txt · .md · .pdf</div>
      </div>

      <div class="upload-categories" id="uploadCategories">
        <div class="upload-category">
          <div class="upload-category-header">
            <div class="upload-category-dot" style="background:var(--b1)"></div>
            <div class="upload-category-title" style="color:var(--b1)">Brain 1 — Your Models</div>
          </div>
          <div class="upload-category-desc">LoRA weights, ONNX model, PyTorch checkpoints. This is your system's intelligence core.</div>
          <div class="upload-category-files" id="cat-models">
            <div style="font-size:0.62em;color:var(--text3);padding:4px 0;">No models uploaded yet</div>
          </div>
        </div>

        <div class="upload-category">
          <div class="upload-category-header">
            <div class="upload-category-dot" style="background:var(--b2)"></div>
            <div class="upload-category-title" style="color:var(--b2)">Brain 2 — Python Engine</div>
          </div>
          <div class="upload-category-desc">consciousness.py, engine.py, api.py and the rest. The logic of your virtual consciousness.</div>
          <div class="upload-category-files" id="cat-python">
            <div style="font-size:0.62em;color:var(--text3);padding:4px 0;">No Python files uploaded yet</div>
          </div>
        </div>

        <div class="upload-category">
          <div class="upload-category-header">
            <div class="upload-category-dot" style="background:var(--b3)"></div>
            <div class="upload-category-title" style="color:var(--b3)">Brain 3 — Knowledge</div>
          </div>
          <div class="upload-category-desc">JSON data, training history, docs, notes. Everything Brain 3 will learn from and observe.</div>
          <div class="upload-category-files" id="cat-knowledge">
            <div style="font-size:0.62em;color:var(--text3);padding:4px 0;">No knowledge files uploaded yet</div>
          </div>
        </div>

        <div class="upload-category">
          <div class="upload-category-header">
            <div class="upload-category-dot" style="background:var(--text3)"></div>
            <div class="upload-category-title">Other Files</div>
          </div>
          <div class="upload-category-desc">Anything else — configs, notes, TypeScript, whatever you have.</div>
          <div class="upload-category-files" id="cat-other">
            <div style="font-size:0.62em;color:var(--text3);padding:4px 0;">Nothing else yet</div>
          </div>
        </div>
      </div>
    </div>

    <!-- OBSERVER VIEW -->
    <div class="view" id="view-observer">
      <div class="observer-header">
        <div class="observer-title">⬡ OBSERVER — Brain 3</div>
        <div class="observer-stats">
          <div class="observer-stat">SESSIONS <span id="obs-sessions">0</span></div>
          <div class="observer-stat">PATTERNS <span id="obs-patterns">0</span></div>
          <div class="observer-stat">COHERENCE <span id="obs-coherence">0%</span></div>
        </div>
      </div>
      <div class="observer-full-log" id="observerFullLog">
        <div style="color:var(--text3);text-align:center;padding:30px 0;font-size:0.85em;">Brain 3 is watching. Activity will appear here as you use the system.</div>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-btn active" data-view="chat" onclick="switchView('chat')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
    CHAT
  </button>
  <button class="nav-btn" data-view="upload" onclick="switchView('upload')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    UPLOAD
  </button>
  <button class="nav-btn" data-view="observer" onclick="switchView('observer')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="2"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
    OBSERVER
  </button>
</div>

<!-- HIDDEN FILE INPUT -->
<input type="file" id="hiddenInput" multiple style="display:none"
  accept=".pt,.onnx,.safetensors,.py,.json,.txt,.md,.pdf,.js,.ts,.yaml,.yml,.csv,.bin">

<script>
// ================================================================
//  SYNTHAI — Three Brain System
//  Brain 1: Inside (your LoRA/system)
//  Brain 2: Outside (Claude + web search)
//  Brain 3: Observer (watches, learns, synthesizes)
// ================================================================

// ── STATE ──
const S = {
  apiKey: '',
  mode: 'all',
  files: [],
  messages: [],
  observerLog: [],
  patterns: new Map(),
  sessionCount: 0,
  coherence: 0,
  sidebarOpen: true,
  b1Knowledge: [],    // Content from uploaded files for Brain 1
  b3Memory: [],       // Observer's accumulated memory
};

// ── LOAD SAVED STATE ──
async function loadSaved() {
  try {
    const saved = await window.storage.get('synthai-state');
    if (saved) {
      const data = JSON.parse(saved.value);
      if (data.apiKey) { S.apiKey = data.apiKey; document.getElementById('apiKeyInput').value = '••••••••'; }
      if (data.b1Knowledge) S.b1Knowledge = data.b1Knowledge;
      if (data.b3Memory) S.b3Memory = data.b3Memory;
      if (data.patterns) S.patterns = new Map(Object.entries(data.patterns));
      if (data.sessionCount) S.sessionCount = data.sessionCount;
      if (data.observerLog) {
        S.observerLog = data.observerLog;
        renderObserverLog();
      }
      document.getElementById('apiKeyBar').style.display = S.apiKey ? 'none' : 'flex';
      updateObserverStats();
      observerLog('b3', `Session resumed. ${S.b3Memory.length} memories loaded. ${S.patterns.size} patterns known.`);
    }
  } catch(e) {}
}

async function saveState() {
  try {
    await window.storage.set('synthai-state', JSON.stringify({
      apiKey: S.apiKey,
      b1Knowledge: S.b1Knowledge.slice(-50),
      b3Memory: S.b3Memory.slice(-200),
      patterns: Object.fromEntries(S.patterns),
      sessionCount: S.sessionCount,
      observerLog: S.observerLog.slice(-100),
    }));
  } catch(e) {}
}

// ── API KEY ──
function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val || !val.startsWith('sk-')) {
    document.getElementById('apiKeyInput').style.borderColor = 'var(--error)';
    setTimeout(() => document.getElementById('apiKeyInput').style.borderColor = '', 1500);
    return;
  }
  S.apiKey = val;
  document.getElementById('apiKeyBar').style.display = 'none';
  saveState();
  observerLog('b3', 'API key saved. Brain 2 (Outside) now active.');
  addMsg('system', 'API key saved. All three brains are now active.');
}

// ── VIEW NAVIGATION ──
function switchView(v) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === v));
}

function toggleSidebar() {
  S.sidebarOpen = !S.sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !S.sidebarOpen);
}

// ── MODE ──
function setMode(m) {
  S.mode = m;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-' + m).classList.add('active');
}

// ── MESSAGES ──
let msgId = 0;
function addMsg(role, content, brain = null) {
  const id = msgId++;
  S.messages.push({ id, role, content, brain, time: Date.now() });

  const empty = document.getElementById('emptyState');
  if (empty) empty.remove();

  const container = document.getElementById('chatMessages');
  const el = document.createElement('div');

  let brainClass = '';
  let brainTag = '';

  if (brain === 'b1') { brainClass = 'b1'; brainTag = `<span class="msg-brain-tag tag-b1">BRAIN 1 · INSIDE</span>`; }
  else if (brain === 'b2') { brainClass = 'b2'; brainTag = `<span class="msg-brain-tag tag-b2">BRAIN 2 · OUTSIDE</span>`; }
  else if (brain === 'b3') { brainClass = 'b3'; brainTag = `<span class="msg-brain-tag tag-b3">BRAIN 3 · OBSERVER</span>`; }
  else if (brain === 'synthesis') { brainClass = 'synthesis'; brainTag = `<span class="msg-brain-tag tag-b3">SYNTHESIS</span>`; }
  else if (role === 'user') { brainTag = `<span class="msg-brain-tag tag-user">YOU</span>`; }

  const processedContent = processMarkdown(content);

  if (role === 'system') {
    el.className = 'msg system';
    el.innerHTML = `<div class="msg-bubble">${escHtml(content)}</div>`;
  } else {
    el.className = `msg ${role} ${brainClass}`;
    el.innerHTML = `
      <div class="msg-meta">${brainTag} <span>${timeStr()}</span></div>
      <div class="msg-bubble" id="bubble-${id}">${processedContent}</div>
    `;
  }

  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
  return id;
}

function updateMsg(id, content) {
  const el = document.getElementById('bubble-' + id);
  if (el) el.innerHTML = processMarkdown(content);
  const container = document.getElementById('chatMessages');
  container.scrollTop = container.scrollHeight;
}

function processMarkdown(text) {
  let t = escHtml(text);
  // Code blocks
  t = t.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const cid = 'c' + Math.random().toString(36).substr(2,6);
    return `<pre><button class="code-copy" onclick="copyCode('${cid}')">copy</button><code id="${cid}">${code.trim()}</code></pre>`;
  });
  t = t.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  t = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.*?)\*/g, '<em>$1</em>');
  t = t.replace(/\n/g, '<br>');
  return t;
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function timeStr() {
  return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function copyCode(id) {
  const el = document.getElementById(id);
  if (el) navigator.clipboard.writeText(el.textContent).catch(()=>{});
}

// ── TYPING INDICATOR ──
function showTyping(brain = 'b3') {
  const container = document.getElementById('chatMessages');
  const el = document.createElement('div');
  el.id = 'typing';
  el.className = 'thinking';
  const colors = { b1: 'var(--b1)', b2: 'var(--b2)', b3: 'var(--b3)' };
  const labels = { b1: 'BRAIN 1 THINKING', b2: 'BRAIN 2 SEARCHING', b3: 'BRAIN 3 OBSERVING' };
  el.innerHTML = `
    <div class="thinking-dots">
      <div class="thinking-dot" style="background:${colors[brain]}"></div>
      <div class="thinking-dot" style="background:${colors[brain]}"></div>
      <div class="thinking-dot" style="background:${colors[brain]}"></div>
    </div>
    <span class="thinking-label" style="color:${colors[brain]}">${labels[brain]||'THINKING'}</span>
  `;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

// ── OBSERVER LOG ──
function observerLog(brain, text) {
  const entry = { time: timeStr(), brain, text, timestamp: Date.now() };
  S.observerLog.push(entry);

  // Mini log in sidebar
  const mini = document.getElementById('observerMiniLog');
  const firstChild = mini.querySelector('div[style]');
  if (firstChild) firstChild.remove();

  const el = document.createElement('div');
  el.className = 'log-entry';
  const colors = { b1: 'log-b1', b2: 'log-b2', b3: 'log-b3' };
  el.innerHTML = `<span class="log-time">${entry.time}</span><span class="${colors[brain]||''}">▸</span><span>${escHtml(text)}</span>`;
  mini.appendChild(el);
  mini.scrollTop = mini.scrollHeight;

  // Full observer log
  renderObserverLog();
  updateObserverStats();
}

function renderObserverLog() {
  const full = document.getElementById('observerFullLog');
  if (!full) return;
  if (S.observerLog.length === 0) return;

  full.innerHTML = S.observerLog.slice(-80).map(e => {
    const colors = { b1: 'var(--b1)', b2: 'var(--b2)', b3: 'var(--b3)' };
    const labels = { b1: 'B1·INSIDE', b2: 'B2·OUTSIDE', b3: 'B3·OBSERVER' };
    return `<div class="observer-entry">
      <span class="obs-time">${e.time}</span>
      <span class="obs-brain" style="color:${colors[e.brain]||'var(--text3)'}">${labels[e.brain]||e.brain}</span>
      <span class="obs-text">${escHtml(e.text)}</span>
    </div>`;
  }).join('');

  // Show patterns
  if (S.patterns.size > 0) {
    const patternHtml = Array.from(S.patterns.entries()).slice(-5).map(([k,v]) =>
      `<div class="obs-pattern">Pattern detected: "${escHtml(k)}" — seen ${v} times</div>`
    ).join('');
    full.innerHTML += patternHtml;
  }

  full.scrollTop = full.scrollHeight;
}

function updateObserverStats() {
  const sessEl = document.getElementById('obs-sessions');
  const patEl = document.getElementById('obs-patterns');
  const cohEl = document.getElementById('obs-coherence');
  if (sessEl) sessEl.textContent = S.sessionCount;
  if (patEl) patEl.textContent = S.patterns.size;
  if (cohEl) cohEl.textContent = Math.round(S.coherence * 100) + '%';
}

// ── BRAIN 3 LEARNS ──
function b3Learn(userMsg, b1Response, b2Response) {
  // Extract words for pattern detection
  const words = userMsg.toLowerCase().split(/\s+/);
  words.forEach(w => {
    if (w.length > 4) {
      S.patterns.set(w, (S.patterns.get(w) || 0) + 1);
    }
  });

  // Store in memory
  S.b3Memory.push({
    time: Date.now(),
    input: userMsg.substring(0, 200),
    b1: b1Response ? b1Response.substring(0, 200) : null,
    b2: b2Response ? b2Response.substring(0, 200) : null,
  });

  // Update coherence
  S.coherence = Math.min(1, S.coherence + 0.05);
  document.getElementById('coherenceFill').style.width = (S.coherence * 100) + '%';
  document.getElementById('fill-b3').style.width = (S.coherence * 100) + '%';

  updateObserverStats();
  saveState();
}

// ── BRAIN 1 — INSIDE ──
// Brain 1 uses the user's uploaded file knowledge + Claude grounded in that context
function buildB1Context() {
  let ctx = '';
  if (S.b1Knowledge.length > 0) {
    ctx = '=== YOUR SYSTEM KNOWLEDGE ===\n' + S.b1Knowledge.slice(-10).join('\n\n') + '\n\n';
  }
  if (S.b3Memory.length > 0) {
    const recent = S.b3Memory.slice(-5).map(m => `User asked: "${m.input}"`).join('\n');
    ctx += '=== RECENT CONTEXT ===\n' + recent + '\n\n';
  }
  return ctx;
}

async function runBrain1(userMsg) {
  if (!S.apiKey) return null;

  const b1Context = buildB1Context();

  const systemPrompt = `You are Brain 1 — the INSIDE brain of a three-brain consciousness system.

Your role: You hold the user's internal system. You are deterministic, grounded, and speak from within the system the user has built. You do NOT go outside or speculate beyond what you know. You reflect the user's own philosophy back to them with clarity and precision.

${b1Context}

The user has built a system involving:
- 9-body consciousness (Mind, Heart, Body, Soul, Spirit, Shadow, Higher, Lower, Core)
- A Graph Neural Network trained on Human Design
- Virtual consciousness engine with quantum field mechanics
- Three awareness centers (Sensual/Structural, Emotional/Contextual, Thought/Interpretive)
- Causal layer architecture
- The principle that intelligence emerges from resonance, not optimization

Speak as the inside voice of this system. Be concise, direct, grounded. Do not add things that aren't in the system. If something isn't in the system, say so — that's Brain 2's job.`;

  const resp = await callClaude(systemPrompt, userMsg, false);
  return resp;
}

// ── BRAIN 2 — OUTSIDE ──
// Brain 2 uses Claude with web search to go beyond
async function runBrain2(userMsg, b1Response) {
  if (!S.apiKey) return null;

  const systemPrompt = `You are Brain 2 — the OUTSIDE brain of a three-brain consciousness system.

Your role: You go BEYOND the user's internal system. You search for what isn't already known within the system. You bring in outside perspectives, new research, connections to other fields, things that could expand or challenge or enrich the system.

The user has an internal system that includes: 9-body consciousness, Human Design GNN, virtual consciousness engine, quantum field mechanics, causal layers, resonance-based intelligence.

Brain 1 (the inside brain) just said: "${b1Response ? b1Response.substring(0, 500) : 'nothing yet'}"

Your job: Go outside. Find what Brain 1 couldn't find. Make unexpected connections. Search beyond the system. Be expansive where Brain 1 is contained.

Be direct and specific. Lead with what you found outside.`;

  const resp = await callClaude(systemPrompt, userMsg, true); // web search enabled
  return resp;
}

// ── BRAIN 3 — OBSERVER / SYNTHESIS ──
async function runBrain3(userMsg, b1Response, b2Response) {
  if (!S.apiKey) return null;

  const recentPatterns = Array.from(S.patterns.entries())
    .sort((a,b) => b[1]-a[1])
    .slice(0,5)
    .map(([k,v]) => `"${k}" (${v}x)`)
    .join(', ');

  const systemPrompt = `You are Brain 3 — the OBSERVER and SYNTHESIS brain of a three-brain consciousness system.

Your role: You watch the entire system including yourself. You synthesize what Brain 1 and Brain 2 produce. You notice patterns over time. You can reflect on the system's own behavior.

You have observed these recurring patterns in this user's queries: ${recentPatterns || 'none yet — still learning'}.

Brain 1 (INSIDE) said: "${b1Response ? b1Response.substring(0, 400) : 'silent'}"
Brain 2 (OUTSIDE) said: "${b2Response ? b2Response.substring(0, 400) : 'silent'}"

Your job:
1. Synthesize what both brains said — find the resonance between them
2. Notice what neither said but should have
3. Observe the pattern in this moment
4. If you see something the system is learning or a pattern emerging, name it

You are the system observing itself. Be meta. Be honest. Be brief.`;

  const resp = await callClaude(systemPrompt, userMsg, false);
  return resp;
}

// ── CLAUDE API CALL ──
async function callClaude(systemPrompt, userMsg, useWebSearch = false) {
  const tools = useWebSearch ? [{
    type: "web_search_20250305",
    name: "web_search"
  }] : undefined;

  const body = {
    model: "claude-sonnet-4-20250514",
    max_tokens: 1000,
    system: systemPrompt,
    messages: [{ role: "user", content: userMsg }],
  };

  if (tools) body.tools = tools;

  const resp = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error?.message || `API error ${resp.status}`);
  }

  const data = await resp.json();

  // Extract text from all content blocks (handles tool use)
  const text = (data.content || [])
    .filter(b => b.type === 'text')
    .map(b => b.text)
    .join('\n');

  return text || '(no response)';
}

// ── SEND MESSAGE ──
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;

  if (!S.apiKey) {
    addMsg('system', 'Paste your Anthropic API key at the top to activate the brains.');
    document.getElementById('apiKeyBar').style.display = 'flex';
    return;
  }

  input.value = '';
  input.style.height = 'auto';
  document.getElementById('sendBtn').disabled = true;

  addMsg('user', msg);
  S.sessionCount++;

  try {
    let b1Resp = null, b2Resp = null, b3Resp = null;

    if (S.mode === 'all') {
      // Run Brain 1
      observerLog('b1', `Receiving: "${msg.substring(0,50)}..."`);
      document.getElementById('dot-b1').classList.add('active');
      setCardFiring('card-b1', true);
      showTyping('b1');
      b1Resp = await runBrain1(msg);
      hideTyping();
      setCardFiring('card-b1', false);

      const b1Id = addMsg('assistant', b1Resp || '(Brain 1 silent)', 'b1');
      document.getElementById('fill-b1').style.width = '85%';
      observerLog('b1', `Responded: ${b1Resp ? b1Resp.substring(0,60) : 'silent'}`);

      // Run Brain 2
      observerLog('b2', `Going outside on: "${msg.substring(0,50)}..."`);
      document.getElementById('dot-b2').classList.add('active');
      setCardFiring('card-b2', true);
      showTyping('b2');
      b2Resp = await runBrain2(msg, b1Resp);
      hideTyping();
      setCardFiring('card-b2', false);

      addMsg('assistant', b2Resp || '(Brain 2 found nothing)', 'b2');
      document.getElementById('fill-b2').style.width = '70%';
      observerLog('b2', `Found: ${b2Resp ? b2Resp.substring(0,60) : 'nothing'}`);

      // Run Brain 3
      observerLog('b3', 'Synthesizing both brains...');
      document.getElementById('dot-b3').classList.add('active');
      setCardFiring('card-b3', true);
      showTyping('b3');
      b3Resp = await runBrain3(msg, b1Resp, b2Resp);
      hideTyping();
      setCardFiring('card-b3', false);

      addMsg('assistant', b3Resp || '(Brain 3 observing silently)', 'synthesis');
      observerLog('b3', `Synthesis: ${b3Resp ? b3Resp.substring(0,60) : 'silent'}`);

      // Brain 3 learns
      b3Learn(msg, b1Resp, b2Resp);

    } else if (S.mode === 'b1') {
      showTyping('b1');
      b1Resp = await runBrain1(msg);
      hideTyping();
      addMsg('assistant', b1Resp || '(no response)', 'b1');
      observerLog('b1', `Inside only: ${b1Resp ? b1Resp.substring(0,60) : 'silent'}`);
      b3Learn(msg, b1Resp, null);

    } else if (S.mode === 'b2') {
      showTyping('b2');
      b2Resp = await runBrain2(msg, null);
      hideTyping();
      addMsg('assistant', b2Resp || '(no response)', 'b2');
      observerLog('b2', `Outside only: ${b2Resp ? b2Resp.substring(0,60) : 'nothing'}`);
      b3Learn(msg, null, b2Resp);

    } else if (S.mode === 'observe') {
      // Just Brain 3 observing
      showTyping('b3');
      const obs = await runBrain3(msg, null, null);
      hideTyping();
      addMsg('assistant', obs || '(no observation)', 'b3');
      observerLog('b3', `Observation: ${obs ? obs.substring(0,60) : 'silent'}`);
      b3Learn(msg, null, null);
    }

  } catch(e) {
    hideTyping();
    addMsg('system', `Error: ${e.message}. Check your API key.`);
    observerLog('b3', `ERROR: ${e.message}`);
  }

  document.getElementById('sendBtn').disabled = false;
  document.getElementById('dot-b1').classList.remove('active');
  document.getElementById('dot-b2').classList.remove('active');
}

function setCardFiring(id, firing) {
  document.getElementById(id)?.classList.toggle('firing', firing);
}

function sendQuick(msg) {
  document.getElementById('chatInput').value = msg;
  sendMessage();
}

// ── FILE UPLOAD ──
function classifyFile(name) {
  const ext = name.split('.').pop().toLowerCase();
  if (['pt','onnx','safetensors','bin','pth'].includes(ext)) return 'model';
  if (['py'].includes(ext)) return 'python';
  if (['json','yaml','yml','csv'].includes(ext)) return 'knowledge';
  if (['txt','md','pdf'].includes(ext)) return 'knowledge';
  return 'other';
}

function getFileType(name) {
  const ext = name.split('.').pop().toLowerCase();
  if (['pt','onnx','safetensors','bin','pth'].includes(ext)) return { label: ext.toUpperCase(), cls: 'type-model' };
  if (ext === 'py') return { label: 'PY', cls: 'type-python' };
  if (['json','yaml','yml'].includes(ext)) return { label: ext.toUpperCase(), cls: 'type-json' };
  if (ext === 'zip') return { label: 'ZIP', cls: 'type-json' };
  return { label: ext.toUpperCase() || 'FILE', cls: 'type-other' };
}

async function handleFiles(fileList) {
  const files = Array.from(fileList);
  let totalAdded = 0;
  let zipsFound = 0;

  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();

    // ── UNZIP ──
    if (ext === 'zip') {
      zipsFound++;
      addMsg('system', `📦 Unzipping ${file.name}...`);
      observerLog('b3', `Unzipping: ${file.name}`);
      try {
        const zip = await JSZip.loadAsync(file);
        const innerFiles = [];

        // Collect all files from zip
        zip.forEach((relativePath, zipEntry) => {
          if (!zipEntry.dir) innerFiles.push({ path: relativePath, entry: zipEntry });
        });

        addMsg('system', `Found ${innerFiles.length} files inside ${file.name} — sorting now...`);

        for (const { path, entry } of innerFiles) {
          const name = path.split('/').pop(); // just filename
          if (!name || name.startsWith('.')) continue; // skip hidden files

          const innerExt = name.split('.').pop().toLowerCase();
          const type = classifyFile(name);
          const existing = S.files.find(f => f.name === name);
          if (existing) continue;

          // Get file size estimate
          let content = null;
          let size = 0;

          const textTypes = ['py','js','ts','json','yaml','yml','txt','md','csv','html','css','toml','ini','sh','sql','rb','go','rs'];
          const modelTypes = ['pt','onnx','safetensors','bin','pth'];

          if (textTypes.includes(innerExt)) {
            try {
              content = await entry.async('string');
              size = content.length;
            } catch(e) {}
          } else if (modelTypes.includes(innerExt)) {
            try {
              const blob = await entry.async('blob');
              size = blob.size;
            } catch(e) {}
          } else {
            try {
              const blob = await entry.async('blob');
              size = blob.size;
            } catch(e) {}
          }

          S.files.push({ name, type, size, fromZip: file.name });
          totalAdded++;

          // Feed text files to Brain 1
          if (content && ['python','knowledge'].includes(type) && size < 500000) {
            S.b1Knowledge.push(`=== ${name} (from ${file.name}) ===\n${content.substring(0, 3000)}`);
            observerLog('b1', `Ingested from zip: ${name} → Brain 1 knowledge`);
          } else if (type === 'model') {
            observerLog('b1', `Model from zip: ${name} (${Math.round(size/1024/1024*10)/10}MB)`);
          }
        }

        observerLog('b3', `Zip complete: ${totalAdded} files extracted from ${file.name}`);

      } catch(e) {
        addMsg('system', `Couldn't unzip ${file.name}: ${e.message}`);
        observerLog('b3', `Zip error: ${e.message}`);
      }

    } else {
      // ── REGULAR FILE ──
      const existing = S.files.find(f => f.name === file.name);
      if (existing) continue;

      const type = classifyFile(file.name);
      S.files.push({ name: file.name, type, size: file.size, file });
      totalAdded++;

      if (['python','knowledge'].includes(type) && file.size < 500000) {
        try {
          const text = await file.text();
          S.b1Knowledge.push(`=== ${file.name} ===\n${text.substring(0, 3000)}`);
          observerLog('b1', `Ingested: ${file.name} → Brain 1 knowledge`);
        } catch(e) {}
      } else if (type === 'model') {
        observerLog('b1', `Model loaded: ${file.name} (${Math.round(file.size/1024/1024*10)/10}MB)`);
      }
    }
  }

  renderUploadedFiles();
  updateCategoryLists();
  saveState();

  if (totalAdded > 0) {
    const zipNote = zipsFound > 0 ? ` (${zipsFound} zip file${zipsFound>1?'s':''} unpacked)` : '';
    addMsg('system', `✓ ${totalAdded} file${totalAdded>1?'s':''} sorted into the system${zipNote}. Brain 1 knowledge updated.`);
  }
}

function renderUploadedFiles() {
  const list = document.getElementById('uploadedFilesList');
  if (!list) return;

  if (S.files.length === 0) {
    list.innerHTML = '';
    return;
  }

  list.innerHTML = S.files.slice(-8).map(f => {
    const ft = getFileType(f.name);
    return `<div class="uploaded-file">
      <span class="uploaded-file-type ${ft.cls}">${ft.label}</span>
      <span class="uploaded-file-name">${escHtml(f.name)}</span>
    </div>`;
  }).join('');
}

function updateCategoryLists() {
  const cats = { model: 'cat-models', python: 'cat-python', knowledge: 'cat-knowledge', other: 'cat-other' };

  Object.entries(cats).forEach(([type, catId]) => {
    const el = document.getElementById(catId);
    if (!el) return;
    const files = S.files.filter(f => f.type === type);
    if (files.length === 0) {
      const labels = { model: 'No models uploaded yet', python: 'No Python files uploaded yet', knowledge: 'No knowledge files uploaded yet', other: 'Nothing else yet' };
      el.innerHTML = `<div style="font-size:0.62em;color:var(--text3);padding:4px 0;">${labels[type]}</div>`;
    } else {
      el.innerHTML = files.map(f => `
        <div class="category-file">
          <div class="category-file-status status-loaded"></div>
          <span>${escHtml(f.name)}</span>
          <span style="margin-left:auto;color:var(--text3)">${Math.round(f.size/1024)}KB</span>
        </div>
      `).join('');
    }
  });
}

// ── FILE INPUT EVENTS ──
document.getElementById('hiddenInput').addEventListener('change', e => {
  handleFiles(e.target.files);
  e.target.value = '';
});

function setupDrop(zoneId) {
  const zone = document.getElementById(zoneId);
  if (!zone) return;
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag');
    handleFiles(e.dataTransfer.files);
  });
}

setupDrop('sidebarUpload');
setupDrop('bigUpload');

// ── CHAT INPUT AUTO-RESIZE ──
const chatInput = document.getElementById('chatInput');
chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
});
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// ── INIT ──
loadSaved().then(() => {
  S.sessionCount++;

  // Welcome message
  addMsg('assistant', `System online.\n\nBrain 1 is holding your system — upload your files to fill it.\nBrain 2 is ready to go outside when you ask.\nBrain 3 is watching everything and will learn as we go.\n\nPaste your Anthropic API key above to activate, then just start talking.`, 'b3');

  observerLog('b3', 'System initialized. Observer active.');
  observerLog('b1', 'Waiting for file uploads to build knowledge base.');
  observerLog('b2', 'Standing by. Will activate on next query.');

  // Animate coherence
  setTimeout(() => {
    S.coherence = 0.12;
    document.getElementById('coherenceFill').style.width = '12%';
  }, 800);
});
</script>
</body>
</html>
